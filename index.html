<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fence Designer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
    }

    /* Header Bar - Section 4.1 */
    .header {
      background: #1a3a2a;
      color: white;
      padding: 16px 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .header-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-group label {
      font-size: 11px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-group input,
    .header-group select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .header-group input {
      min-width: 120px;
    }

    .header-group select {
      min-width: 140px;
    }

    /* Main Layout - Section 4 */
    .main {
      display: flex;
      height: calc(100vh - 80px);
    }

    .left-panel {
      width: 40%;
      background: white;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }

    .right-panel {
      width: 60%;
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }

    /* Run Tabs */
    .run-tabs {
      display: flex;
      background: #e9ecef;
      border-bottom: 2px solid #dee2e6;
      padding: 8px 8px 0 8px;
      gap: 4px;
    }

    .run-tab {
      padding: 8px 16px;
      background: white;
      border: 1px solid #dee2e6;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      font-size: 14px;
      position: relative;
    }

    .run-tab.active {
      background: white;
      font-weight: 600;
      border-bottom: 2px solid white;
      margin-bottom: -2px;
    }

    .run-tab:not(.active) {
      background: #f8f9fa;
      color: #6c757d;
    }

    .run-tab:not(.active):hover {
      background: #e9ecef;
    }

    .add-run-btn {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .add-run-btn:hover {
      background: #218838;
    }

    /* Run Content */
    .run-content {
      padding: 20px;
    }

    .run-settings {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .run-settings h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #495057;
    }

    .run-settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 12px;
      font-weight: 500;
      color: #495057;
    }

    .form-group input,
    .form-group select {
      padding: 6px 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Quick Retaining Tool */
    .quick-retaining {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .quick-retaining h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #004085;
    }

    .quick-retaining-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .quick-retaining button {
      padding: 6px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .quick-retaining button:hover {
      background: #0056b3;
    }

    /* Panel Table - Section 4.2 */
    .panel-table-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #495057;
    }

    .panel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .panel-table th {
      background: #e9ecef;
      padding: 8px;
      text-align: left;
      font-weight: 600;
      border: 1px solid #dee2e6;
      font-size: 12px;
    }

    .panel-table td {
      padding: 6px 8px;
      border: 1px solid #dee2e6;
    }

    .panel-table input[type="number"] {
      width: 80px;
      padding: 4px 6px;
      border: 1px solid #ced4da;
      border-radius: 3px;
    }

    .panel-table select {
      padding: 4px 6px;
      border: 1px solid #ced4da;
      border-radius: 3px;
    }

    .panel-table .calc-value {
      font-weight: 600;
      color: #495057;
    }

    .delete-panel-btn {
      padding: 4px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .delete-panel-btn:hover {
      background: #c82333;
    }

    .add-panel-btn {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .add-panel-btn:hover {
      background: #218838;
    }

    /* Right Panel */
    .visualiser-placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #adb5bd;
      font-weight: 300;
    }

    .stats-bar {
      background: white;
      border-top: 1px solid #dee2e6;
      padding: 16px 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-item label {
      font-size: 11px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-item .value {
      font-size: 18px;
      font-weight: 600;
      color: #212529;
    }

    .generate-btn {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }

    .generate-btn:hover {
      background: #0056b3;
    }

    /* Compliance Warning - Section 11 */
    .compliance-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-left: 4px solid #ffc107;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 4px;
      display: none;
    }

    .compliance-warning.show {
      display: block;
    }

    .compliance-warning h4 {
      font-size: 14px;
      font-weight: 600;
      color: #856404;
      margin-bottom: 6px;
    }

    .compliance-warning ul {
      margin-left: 20px;
      color: #856404;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Header Bar -->
  <div class="header">
    <div class="header-group">
      <label>Job Ref</label>
      <input type="text" id="jobRef" placeholder="e.g. 2024-001">
    </div>
    <div class="header-group">
      <label>Client</label>
      <input type="text" id="client" placeholder="Client name">
    </div>
    <div class="header-group">
      <label>Address</label>
      <input type="text" id="address" placeholder="Site address">
    </div>
    <div class="header-group">
      <label>Supplier</label>
      <select id="supplier">
        <option value="RNR">RNR</option>
        <option value="Metroll">Metroll</option>
        <option value="Lysaght">Lysaght</option>
        <option value="Stratco">Stratco</option>
      </select>
    </div>
    <div class="header-group">
      <label>Profile</label>
      <select id="profile">
        <option value="Trimclad">Trimclad</option>
        <option value="Harmony">Harmony</option>
        <option value="Spandek">Spandek</option>
        <option value="Corrugated">Corrugated</option>
      </select>
    </div>
    <div class="header-group">
      <label>Colour</label>
      <select id="colour"></select>
    </div>
    <div class="header-group">
      <label>$/metre</label>
      <input type="number" id="pricePerMetre" placeholder="0.00" step="0.01" min="0">
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main">
    <!-- Left Panel -->
    <div class="left-panel">
      <!-- Run Tabs -->
      <div class="run-tabs" id="runTabs">
        <button class="add-run-btn" onclick="app.addRun()">+ Add Run</button>
      </div>

      <!-- Run Content -->
      <div class="run-content" id="runContent">
        <!-- Dynamically populated -->
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <!-- Visualiser Placeholder -->
      <div class="visualiser-placeholder">
        Profile View
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stats-grid">
          <div class="stat-item">
            <label>Total Panels</label>
            <div class="value" id="statPanels">0</div>
          </div>
          <div class="stat-item">
            <label>Total Posts</label>
            <div class="value" id="statPosts">0</div>
          </div>
          <div class="stat-item">
            <label>Total Metres</label>
            <div class="value" id="statMetres">0.0</div>
          </div>
          <div class="stat-item">
            <label>Total Cost</label>
            <div class="value" id="statCost">$0.00</div>
          </div>
        </div>
        <button class="generate-btn" onclick="app.generateOutputs()">Generate Outputs</button>
      </div>
    </div>
  </div>

  <script>
    // Section 9: Colour data with hex codes
    const COLOURS = [
      { name: 'Classic Cream™', hex: '#E8D7B8' },
      { name: 'Cottage Green™', hex: '#404F3A' },
      { name: 'Cove™', hex: '#B8BCBC' },
      { name: 'Dune®', hex: '#C9BCA1' },
      { name: 'Evening Haze®', hex: '#626466' },
      { name: 'Gully™', hex: '#565A5C' },
      { name: 'Ironstone®', hex: '#3F3834' },
      { name: 'Jasper®', hex: '#8B7F77' },
      { name: 'Mangrove™', hex: '#5D5852' },
      { name: 'Manor Red®', hex: '#6F413A' },
      { name: 'Monument®', hex: '#3A3A3A' },
      { name: 'Night Sky®', hex: '#1F1F27' },
      { name: 'Pale Eucalypt®', hex: '#BDC7B8' },
      { name: 'Paperbark®', hex: '#B5AA9C' },
      { name: 'Shale Grey™', hex: '#898D8D' },
      { name: 'Surfmist®', hex: '#DCDBD9' },
      { name: 'Terrain®', hex: '#9A8C7C' },
      { name: 'Wallaby®', hex: '#8C8675' },
      { name: 'Wilderness®', hex: '#464C43' },
      { name: 'Windspray®', hex: '#ACAFB0' },
      { name: 'Woodland Grey®', hex: '#494B48' }
    ];

    // Application State
    const app = {
      job: null,
      currentRunId: null,

      init() {
        this.loadFromStorage();
        this.populateColourDropdown();
        this.bindHeaderInputs();

        if (!this.job) {
          this.job = {
            jobRef: '',
            client: '',
            address: '',
            supplier: 'RNR',
            profile: 'Trimclad',
            colour: COLOURS[0].name,
            pricePerMetre: 0,
            runs: []
          };
          this.addRun();
        } else {
          this.syncHeaderFromJob();
          if (this.job.runs.length > 0) {
            this.currentRunId = this.job.runs[0].id;
          }
        }

        this.render();
      },

      populateColourDropdown() {
        const select = document.getElementById('colour');
        select.innerHTML = COLOURS.map(c =>
          `<option value="${c.name}" data-hex="${c.hex}">
            ${c.name}
          </option>`
        ).join('');
      },

      bindHeaderInputs() {
        document.getElementById('jobRef').addEventListener('input', (e) => {
          this.job.jobRef = e.target.value;
          this.save();
        });
        document.getElementById('client').addEventListener('input', (e) => {
          this.job.client = e.target.value;
          this.save();
        });
        document.getElementById('address').addEventListener('input', (e) => {
          this.job.address = e.target.value;
          this.save();
        });
        document.getElementById('supplier').addEventListener('change', (e) => {
          this.job.supplier = e.target.value;
          this.save();
        });
        document.getElementById('profile').addEventListener('change', (e) => {
          this.job.profile = e.target.value;
          this.recalculateAll();
          this.save();
        });
        document.getElementById('colour').addEventListener('change', (e) => {
          this.job.colour = e.target.value;
          this.save();
        });
        document.getElementById('pricePerMetre').addEventListener('input', (e) => {
          this.job.pricePerMetre = parseFloat(e.target.value) || 0;
          this.updateStats();
          this.save();
        });
      },

      syncHeaderFromJob() {
        document.getElementById('jobRef').value = this.job.jobRef;
        document.getElementById('client').value = this.job.client;
        document.getElementById('address').value = this.job.address;
        document.getElementById('supplier').value = this.job.supplier;
        document.getElementById('profile').value = this.job.profile;
        document.getElementById('colour').value = this.job.colour;
        document.getElementById('pricePerMetre').value = this.job.pricePerMetre;
      },

      // Section 6.1: Panel Width Calculation
      getPanelWidth() {
        return this.job.profile === 'Spandek' ? 2.5 : 2.4;
      },

      // Section 6.2: Plinth Calculation
      calculatePlinth(retaining) {
        if (retaining === 0) return 0;
        return Math.floor(retaining / 150) * 150 + 150;
      },

      // Section 6.3: Post Height Calculation
      calculatePostHeights(panel, index, panels) {
        const allowedPostHeights = [2400, 2700, 3000];

        // Left Post
        let leftBase;
        if (index === 0) {
          leftBase = 0;
        } else {
          leftBase = Math.max(panels[index - 1].retaining, panel.retaining);
        }

        let leftNeeded = leftBase + panel.height;
        if (panel.extension === 'Patio Tube') leftNeeded += 300;
        else if (panel.extension === 'Flat Top') leftNeeded += 150;

        const postLeft = allowedPostHeights.find(h => h >= leftNeeded) || 3000;

        // Right Post
        let rightBase;
        if (index === panels.length - 1) {
          rightBase = panel.retaining;
        } else {
          rightBase = Math.max(panel.retaining, panels[index + 1].retaining);
        }

        let rightNeeded = rightBase + panel.height;
        if (panel.extension === 'Patio Tube') rightNeeded += 300;
        else if (panel.extension === 'Flat Top') rightNeeded += 150;

        const postRight = allowedPostHeights.find(h => h >= rightNeeded) || 3000;

        return { postLeft, postRight };
      },

      recalculateRun(runId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        run.panels.forEach((panel, index) => {
          panel.plinth = this.calculatePlinth(panel.retaining);
          const posts = this.calculatePostHeights(panel, index, run.panels);
          panel.postLeft = posts.postLeft;
          panel.postRight = posts.postRight;
        });
      },

      recalculateAll() {
        this.job.runs.forEach(run => this.recalculateRun(run.id));
        this.render();
      },

      addRun() {
        const runNumber = this.job.runs.length + 1;
        const run = {
          id: 'run-' + Date.now(),
          name: `Run ${runNumber}`,
          length: 10,
          defaultHeight: 1800,
          extension: null,
          panels: []
        };

        this.job.runs.push(run);
        this.currentRunId = run.id;
        this.addPanel(run.id);
        this.save();
        this.render();
      },

      switchRun(runId) {
        this.currentRunId = runId;
        this.render();
      },

      addPanel(runId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        const panel = {
          id: 'panel-' + Date.now(),
          retaining: 0,
          height: run.defaultHeight,
          extension: run.extension,
          plinth: 0,
          postLeft: 0,
          postRight: 0
        };

        run.panels.push(panel);
        this.recalculateRun(runId);
        this.save();
        this.render();
      },

      deletePanel(runId, panelId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run || run.panels.length <= 1) {
          alert('Each run must have at least 1 panel.');
          return;
        }

        run.panels = run.panels.filter(p => p.id !== panelId);
        this.recalculateRun(runId);
        this.save();
        this.render();
      },

      updatePanel(runId, panelId, field, value) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        const panel = run.panels.find(p => p.id === panelId);
        if (!panel) return;

        if (field === 'retaining') {
          panel.retaining = parseInt(value) || 0;
        } else if (field === 'height') {
          panel.height = parseInt(value);
        } else if (field === 'extension') {
          panel.extension = value === 'null' ? null : value;
        }

        this.recalculateRun(runId);
        this.save();
        this.render();
      },

      updateRunSettings(runId, field, value) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        if (field === 'name') {
          run.name = value;
        } else if (field === 'length') {
          run.length = parseFloat(value) || 0;
        } else if (field === 'defaultHeight') {
          run.defaultHeight = parseInt(value);
        } else if (field === 'extension') {
          run.extension = value === 'null' ? null : value;
        }

        this.save();
        this.render();
      },

      applyQuickRetaining(runId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        const startPanel = parseInt(document.getElementById(`qr-start-${runId}`).value) - 1;
        const endPanel = parseInt(document.getElementById(`qr-end-${runId}`).value) - 1;
        const retaining = parseInt(document.getElementById(`qr-retaining-${runId}`).value) || 0;

        if (startPanel < 0 || endPanel >= run.panels.length || startPanel > endPanel) {
          alert('Invalid panel range.');
          return;
        }

        for (let i = startPanel; i <= endPanel; i++) {
          run.panels[i].retaining = retaining;
        }

        this.recalculateRun(runId);
        this.save();
        this.render();
      },

      // Section 11: Compliance Warnings
      getComplianceWarnings() {
        const warnings = [];

        this.job.runs.forEach(run => {
          // Patio Tube only if <= 5 panels
          const hasPatioTube = run.panels.some(p => p.extension === 'Patio Tube');
          if (hasPatioTube && run.panels.length > 5) {
            warnings.push(`${run.name}: Patio Tube extension is only allowed for runs with 5 or fewer panels.`);
          }

          // Check post heights
          run.panels.forEach((panel, idx) => {
            if (![2400, 2700, 3000].includes(panel.postLeft)) {
              warnings.push(`${run.name} Panel ${idx + 1}: Left post height ${panel.postLeft}mm is not standard (2400/2700/3000).`);
            }
            if (![2400, 2700, 3000].includes(panel.postRight)) {
              warnings.push(`${run.name} Panel ${idx + 1}: Right post height ${panel.postRight}mm is not standard (2400/2700/3000).`);
            }
          });
        });

        return warnings;
      },

      updateStats() {
        let totalPanels = 0;
        let totalPosts = 0;
        let totalMetres = 0;

        this.job.runs.forEach(run => {
          totalPanels += run.panels.length;
          totalPosts += run.panels.length + 1; // n panels need n+1 posts
          totalMetres += run.panels.length * this.getPanelWidth();
        });

        const totalCost = totalMetres * this.job.pricePerMetre;

        document.getElementById('statPanels').textContent = totalPanels;
        document.getElementById('statPosts').textContent = totalPosts;
        document.getElementById('statMetres').textContent = totalMetres.toFixed(1);
        document.getElementById('statCost').textContent = `$${totalCost.toFixed(2)}`;
      },

      render() {
        this.renderRunTabs();
        this.renderRunContent();
        this.updateStats();
      },

      renderRunTabs() {
        const tabsHtml = this.job.runs.map(run => `
          <div class="run-tab ${run.id === this.currentRunId ? 'active' : ''}"
               onclick="app.switchRun('${run.id}')">
            ${run.name}
          </div>
        `).join('');

        document.getElementById('runTabs').innerHTML = `
          ${tabsHtml}
          <button class="add-run-btn" onclick="app.addRun()">+ Add Run</button>
        `;
      },

      renderRunContent() {
        const run = this.job.runs.find(r => r.id === this.currentRunId);
        if (!run) {
          document.getElementById('runContent').innerHTML = '<p style="padding: 20px;">No run selected.</p>';
          return;
        }

        const warnings = this.getComplianceWarnings();
        const warningsHtml = warnings.length > 0 ? `
          <div class="compliance-warning show">
            <h4>Compliance Warnings</h4>
            <ul>
              ${warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
          </div>
        ` : '';

        const panelsHtml = run.panels.map((panel, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>
              <input type="number" value="${panel.retaining}" min="0" step="50"
                     onchange="app.updatePanel('${run.id}', '${panel.id}', 'retaining', this.value)">
            </td>
            <td>
              <select onchange="app.updatePanel('${run.id}', '${panel.id}', 'height', this.value)">
                <option value="1800" ${panel.height === 1800 ? 'selected' : ''}>1800</option>
                <option value="2100" ${panel.height === 2100 ? 'selected' : ''}>2100</option>
              </select>
            </td>
            <td>
              <select onchange="app.updatePanel('${run.id}', '${panel.id}', 'extension', this.value)">
                <option value="null" ${panel.extension === null ? 'selected' : ''}>-</option>
                <option value="Patio Tube" ${panel.extension === 'Patio Tube' ? 'selected' : ''}>Patio</option>
                <option value="Flat Top" ${panel.extension === 'Flat Top' ? 'selected' : ''}>Flat</option>
              </select>
            </td>
            <td class="calc-value">${panel.plinth}</td>
            <td class="calc-value">${panel.postLeft}</td>
            <td class="calc-value">${panel.postRight}</td>
            <td>
              <button class="delete-panel-btn" onclick="app.deletePanel('${run.id}', '${panel.id}')">Delete</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('runContent').innerHTML = `
          ${warningsHtml}

          <div class="run-settings">
            <h3>Run Settings</h3>
            <div class="run-settings-grid">
              <div class="form-group">
                <label>Name</label>
                <input type="text" value="${run.name}"
                       onchange="app.updateRunSettings('${run.id}', 'name', this.value)">
              </div>
              <div class="form-group">
                <label>Length (m)</label>
                <input type="number" value="${run.length}" min="0" step="0.1"
                       onchange="app.updateRunSettings('${run.id}', 'length', this.value)">
              </div>
              <div class="form-group">
                <label>Default Height</label>
                <select onchange="app.updateRunSettings('${run.id}', 'defaultHeight', this.value)">
                  <option value="1800" ${run.defaultHeight === 1800 ? 'selected' : ''}>1800</option>
                  <option value="2100" ${run.defaultHeight === 2100 ? 'selected' : ''}>2100</option>
                </select>
              </div>
              <div class="form-group">
                <label>Extension</label>
                <select onchange="app.updateRunSettings('${run.id}', 'extension', this.value)">
                  <option value="null" ${run.extension === null ? 'selected' : ''}>None</option>
                  <option value="Patio Tube" ${run.extension === 'Patio Tube' ? 'selected' : ''}>Patio Tube</option>
                  <option value="Flat Top" ${run.extension === 'Flat Top' ? 'selected' : ''}>Flat Top</option>
                </select>
              </div>
            </div>
          </div>

          <div class="quick-retaining">
            <h3>Quick Retaining Tool</h3>
            <div class="quick-retaining-grid">
              <div class="form-group">
                <label>From Panel</label>
                <input type="number" id="qr-start-${run.id}" min="1" max="${run.panels.length}" value="1">
              </div>
              <div class="form-group">
                <label>To Panel</label>
                <input type="number" id="qr-end-${run.id}" min="1" max="${run.panels.length}" value="${run.panels.length}">
              </div>
              <div class="form-group">
                <label>Retaining (mm)</label>
                <input type="number" id="qr-retaining-${run.id}" min="0" step="50" value="0">
              </div>
              <button onclick="app.applyQuickRetaining('${run.id}')">Apply</button>
            </div>
          </div>

          <div class="panel-table-section">
            <h3>Panel Table</h3>
            <table class="panel-table">
              <thead>
                <tr>
                  <th>Panel #</th>
                  <th>Retaining (mm)</th>
                  <th>Height</th>
                  <th>Ext</th>
                  <th>Plinths (Pl)</th>
                  <th>Post L</th>
                  <th>Post R</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                ${panelsHtml}
              </tbody>
            </table>
            <button class="add-panel-btn" onclick="app.addPanel('${run.id}')">+ Add Panel</button>
          </div>
        `;
      },

      generateOutputs() {
        alert('Output generation not yet implemented.');
      },

      // Section 10.5: Auto-save to localStorage
      save() {
        localStorage.setItem('fenceJob', JSON.stringify(this.job));
      },

      loadFromStorage() {
        const saved = localStorage.getItem('fenceJob');
        if (saved) {
          this.job = JSON.parse(saved);
          // Ensure currentRunId is set
          if (this.job.runs.length > 0 && !this.currentRunId) {
            this.currentRunId = this.job.runs[0].id;
          }
        }
      }
    };

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>
