<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fence Designer Pro ‚Äî SecureWorks WA</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 400;
      background: #f8fafc;
    }

    /* Section 0: Branding */
    .header {
      background: #293C46;
      color: #FFFFFF;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .header-brand {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 16px;
      margin-right: 8px;
      white-space: nowrap;
    }

    .header-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .header-group label {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.85;
    }

    .header-group input,
    .header-group select {
      padding: 5px 8px;
      border: 1px solid #4C6A70;
      border-radius: 4px;
      font-size: 13px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .header-group input {
      min-width: 100px;
    }

    .header-group select {
      min-width: 120px;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .header-actions .saved-indicator {
      font-size: 12px;
      opacity: 0.7;
    }

    .btn-header {
      padding: 6px 14px;
      background: #F15A29;
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .btn-header:hover {
      background: #d94e22;
    }

    /* Main Layout */
    .main {
      display: flex;
      height: calc(100vh - 72px);
    }

    .left-panel {
      width: 40%;
      min-width: 450px;
      background: #FFFFFF;
      overflow-y: auto;
      border-right: 1px solid #4C6A70;
    }

    .right-panel {
      width: 60%;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
    }

    /* Run Tabs */
    .run-tabs {
      display: flex;
      background: #F5F5F5;
      border-bottom: 2px solid #4C6A70;
      padding: 8px 8px 0 8px;
      gap: 4px;
      flex-wrap: wrap;
    }

    .run-tab {
      padding: 8px 16px;
      background: #e5e7eb;
      border: 1px solid #4C6A70;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      font-size: 13px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 400;
      color: #4C6A70;
    }

    .run-tab.active {
      background: #FFFFFF;
      font-weight: 700;
      color: #293C46;
      border-bottom: 2px solid #FFFFFF;
      margin-bottom: -2px;
      border-left-color: #F15A29;
      border-top: 2px solid #F15A29;
      border-right-color: #F15A29;
    }

    .run-tab:not(.active):hover {
      background: #d1d5db;
    }

    .add-run-btn {
      padding: 8px 16px;
      background: transparent;
      color: #F15A29;
      border: 2px dashed #F15A29;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .add-run-btn:hover {
      background: rgba(241, 90, 41, 0.08);
    }

    /* Run Content */
    .run-content {
      padding: 16px;
    }

    .run-settings {
      background: #F5F5F5;
      padding: 14px;
      border-radius: 4px;
      margin-bottom: 16px;
      border: 1px solid #4C6A70;
    }

    .run-settings h3 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 10px;
      color: #293C46;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .run-settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .run-settings-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .form-group label {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 11px;
      color: #4C6A70;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .form-group input,
    .form-group select {
      padding: 5px 8px;
      border: 1px solid #4C6A70;
      border-radius: 4px;
      font-size: 13px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #F15A29;
      box-shadow: 0 0 0 2px rgba(241, 90, 41, 0.15);
    }

    .btn-orange {
      padding: 6px 14px;
      background: #F15A29;
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .btn-orange:hover {
      background: #d94e22;
    }

    .btn-delete {
      padding: 6px 14px;
      background: transparent;
      color: #dc2626;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .btn-delete:hover {
      text-decoration: underline;
    }

    /* Quick Retaining Tool */
    .quick-retaining {
      background: #fef3c7;
      border: 1px solid #4C6A70;
      padding: 14px;
      border-radius: 4px;
      margin-bottom: 16px;
    }

    .quick-retaining h3 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 10px;
      color: #293C46;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .quick-retaining-row {
      display: flex;
      gap: 10px;
      align-items: end;
    }

    /* Panel Table */
    .panel-table-section {
      margin-bottom: 16px;
    }

    .panel-table-section h3 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      color: #293C46;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .panel-table-wrap {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #4C6A70;
      border-radius: 4px;
    }

    .panel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .panel-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .panel-table th {
      background: #F5F5F5;
      padding: 6px 6px;
      text-align: center;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 11px;
      color: #293C46;
      border-bottom: 2px solid #4C6A70;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .panel-table td {
      padding: 4px 4px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      font-size: 12px;
    }

    .panel-table tbody tr:nth-child(even) {
      background: #F5F5F5;
    }

    .panel-table tbody tr:hover {
      background: #e0f2fe;
    }

    .panel-table select {
      padding: 2px 4px;
      border: 1px solid #4C6A70;
      border-radius: 3px;
      font-size: 12px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      text-align: center;
    }

    .panel-table .col-pnum {
      width: 30px;
      font-weight: 700;
      color: #293C46;
    }

    .panel-table .col-ht {
      width: 50px;
    }

    .panel-table .col-ret {
      width: 60px;
    }

    .panel-table .col-pl {
      width: 30px;
      font-weight: 700;
      color: #4C6A70;
    }

    .panel-table .col-step {
      width: 30px;
      color: #4C6A70;
    }

    .panel-table .col-total {
      width: 45px;
      font-weight: 700;
    }

    .panel-table .col-post {
      width: 55px;
      font-weight: 700;
    }

    .panel-table .col-del {
      width: 20px;
    }

    .total-standard {
      color: #16a34a;
    }

    .total-elevated {
      color: #F15A29;
    }

    .post-patio {
      color: #F15A29;
    }

    .delete-panel-btn {
      background: none;
      border: none;
      color: #dc2626;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      padding: 2px 4px;
    }

    .delete-panel-btn:hover {
      background: #fee2e2;
      border-radius: 3px;
    }

    /* Gates */
    .gates-section {
      margin-bottom: 16px;
    }

    .gates-section h3 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      color: #293C46;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .gate-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .gate-row select,
    .gate-row input {
      padding: 4px 6px;
      border: 1px solid #4C6A70;
      border-radius: 3px;
      font-size: 12px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* Right Panel */
    .view-tabs {
      display: flex;
      background: #F5F5F5;
      border-bottom: 1px solid #4C6A70;
      padding: 0 16px;
    }

    .view-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      color: #4C6A70;
      border-bottom: 3px solid transparent;
    }

    .view-tab.active {
      color: #F15A29;
      border-bottom-color: #F15A29;
    }

    .visualiser-placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #4C6A70;
      font-weight: 400;
    }

    .stats-bar {
      background: #FFFFFF;
      border-top: 1px solid #4C6A70;
      padding: 14px 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 14px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-item label {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 10px;
      color: #4C6A70;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-item .value {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: #293C46;
    }

    .stat-item .value.price-badge {
      color: #16a34a;
    }

    .generate-btn {
      width: 100%;
      padding: 12px;
      background: #F15A29;
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .generate-btn:hover {
      background: #d94e22;
    }

    /* Compliance Warnings */
    .compliance-warning {
      border: 1px solid #dc2626;
      border-left: 4px solid #dc2626;
      padding: 10px 14px;
      margin-bottom: 12px;
      border-radius: 4px;
      background: #fef2f2;
    }

    .compliance-warning.warn {
      border-color: #f59e0b;
      background: #fffbeb;
    }

    .compliance-warning h4 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .compliance-warning p {
      font-size: 12px;
    }

    /* Colour swatch in dropdown */
    .colour-option-swatch {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ccc;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* No shadows heavier than spec */
    * {
      box-shadow: none;
    }
  </style>
</head>
<body>
  <!-- Header Bar -->
  <div class="header">
    <div class="header-brand">SW</div>
    <div class="header-group">
      <label>Job Ref</label>
      <input type="text" id="jobRef" placeholder="SW9248">
    </div>
    <div class="header-group">
      <label>Client</label>
      <input type="text" id="client" placeholder="Client name">
    </div>
    <div class="header-group">
      <label>Address</label>
      <input type="text" id="address" placeholder="Site address" style="min-width:160px;">
    </div>
    <div class="header-group">
      <label>Supplier</label>
      <select id="supplier">
        <option value="RNR">RNR</option>
        <option value="Metroll">Metroll</option>
        <option value="Lysaght">Lysaght</option>
        <option value="Stratco">Stratco</option>
      </select>
    </div>
    <div class="header-group">
      <label>Profile</label>
      <select id="profile"></select>
    </div>
    <div class="header-group">
      <label>Colour</label>
      <select id="colour"></select>
    </div>
    <div class="header-group">
      <label>$/Metre</label>
      <input type="number" id="pricePerMetre" value="115" step="0.01" min="0" style="min-width:70px;">
    </div>
    <div class="header-actions">
      <span class="saved-indicator" id="savedIndicator">Saved</span>
      <button class="btn-header" onclick="app.newJob()">New</button>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="run-tabs" id="runTabs"></div>
      <div class="run-content" id="runContent"></div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div class="view-tabs">
        <button class="view-tab active">Profile View</button>
        <button class="view-tab">3D View</button>
      </div>
      <div class="visualiser-placeholder">
        Profile View ‚Äî coming soon
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stats-grid">
          <div class="stat-item">
            <label>Metres</label>
            <div class="value" id="statMetres">0.0m</div>
          </div>
          <div class="stat-item">
            <label>Panels</label>
            <div class="value" id="statPanels">0</div>
          </div>
          <div class="stat-item">
            <label>Posts</label>
            <div class="value" id="statPosts">0</div>
          </div>
          <div class="stat-item">
            <label>Plinths</label>
            <div class="value" id="statPlinths">0</div>
          </div>
          <div class="stat-item">
            <label>Est. Total</label>
            <div class="value price-badge" id="statCost">$0</div>
          </div>
        </div>
        <button class="generate-btn" onclick="app.generateOutputs()">Generate Outputs</button>
      </div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Section 4B: Supplier profiles ‚îÄ‚îÄ
    const SUPPLIER_PROFILES = {
      RNR:    { profiles: ['Ridgeside', 'Sameside'], panelWidth: 2380 },
      Metroll:{ profiles: ['Trimclad', 'Harmony'],   panelWidth: 2365 },
      Lysaght:{ profiles: ['Neetascreen', 'Smartascreen'], panelWidth: 2360 },
      Stratco:{ profiles: ['Superdek', 'Good Neighbour'],  panelWidth: 2350 }
    };

    // ‚îÄ‚îÄ Section 9: Colorbond fencing colour palette ‚îÄ‚îÄ
    const COLOURS_STOCK = [
      { name: 'Surfmist',       hex: '#E4E2D5' },
      { name: 'Domain',         hex: '#E8DBAE' },
      { name: 'Evening Haze',   hex: '#C5C2AA' },
      { name: 'Paperbark',      hex: '#CABFA4' },
      { name: 'Dune',           hex: '#B1ADA3' },
      { name: 'Shale Grey',     hex: '#BDBFBA' },
      { name: 'Riversand',      hex: '#9D8D76' },
      { name: 'Bluegum',        hex: '#969799' },
      { name: 'Pale Eucalypt',  hex: '#7C846A' },
      { name: 'Wilderness',     hex: '#64715E' },
      { name: 'Basalt',         hex: '#6D6C6E' },
      { name: 'Woodland Grey',  hex: '#4B4C46' },
      { name: 'Ironstone',      hex: '#3E434C' },
      { name: 'Monument',       hex: '#323233' },
      { name: 'Wollemi',        hex: '#0A1C0D' }
    ];

    const COLOURS_SPECIAL = [
      { name: 'Deep Ocean',   hex: '#364152' },
      { name: 'Cottage Green',hex: '#304C3C' },
      { name: 'Night Sky',    hex: '#2E2E2F' },
      { name: 'Manor Red',    hex: '#5E1D0E' },
      { name: 'Jasper',       hex: '#6C6153' },
      { name: 'Windspray',    hex: '#888B8A' }
    ];

    // ‚îÄ‚îÄ Section 6.3: Post height lookup tables ‚îÄ‚îÄ
    // Key: sheetHeight, Value: array of { maxRetaining, postSize, patioTube }
    const POST_LOOKUP = {
      1200: [
        { ret: 0,   post: 2400, patio: false },
        { ret: 150, post: 2400, patio: false },
        { ret: 300, post: 2400, patio: false },
        { ret: 450, post: 2400, patio: false },
        { ret: 600, post: 2400, patio: false },
        { ret: 750, post: 2700, patio: false }
      ],
      1500: [
        { ret: 0,   post: 2400, patio: false },
        { ret: 150, post: 2400, patio: false },
        { ret: 300, post: 2400, patio: false },
        { ret: 450, post: 2700, patio: true },
        { ret: 600, post: 2700, patio: true },
        { ret: 750, post: 3000, patio: true }
      ],
      1800: [
        { ret: 0,   post: 2400, patio: false },
        { ret: 150, post: 2700, patio: false },
        { ret: 300, post: 2700, patio: false },
        { ret: 450, post: 3000, patio: true },
        { ret: 600, post: 3000, patio: true },
        { ret: 750, post: 3000, patio: true }
      ],
      2100: [
        { ret: 0,   post: 2700, patio: false },
        { ret: 150, post: 3000, patio: false },
        { ret: 300, post: 3000, patio: false },
        { ret: 450, post: 3000, patio: true },
        { ret: 600, post: 3000, patio: true },
        { ret: 750, post: 3000, patio: true }
      ]
    };

    const RETAINING_OPTIONS = [0, 150, 300, 450, 600, 750];
    const SHEET_HEIGHTS = [1200, 1500, 1800, 2100];
    const RUN_NAME_CYCLE = ['Rear', 'LHS', 'RHS', 'Front'];

    // ‚îÄ‚îÄ Lookup helper ‚îÄ‚îÄ
    function lookupPost(sheetHeight, retaining) {
      const table = POST_LOOKUP[sheetHeight] || POST_LOOKUP[1800];
      const entry = table.find(e => e.ret === retaining);
      if (entry) return entry;
      // Fallback: use the formula from Section 6.3
      const totalFence = sheetHeight + retaining;
      const required = totalFence + 600;
      let postSize;
      if (required <= 2400) postSize = 2400;
      else if (required <= 2700) postSize = 2700;
      else if (required <= 3000) postSize = 3000;
      else postSize = 3000;
      const plinths = retaining / 150;
      return { ret: retaining, post: postSize, patio: plinths >= 3 && plinths <= 5 };
    }

    // ‚îÄ‚îÄ Application ‚îÄ‚îÄ
    const app = {
      job: null,
      currentRunId: null,

      init() {
        this.loadFromStorage();
        this.populateColourDropdown();
        this.bindHeaderInputs();

        if (!this.job) {
          this.job = {
            ref: '',
            client: '',
            address: '',
            supplier: 'RNR',
            profile: 'Ridgeside',
            colour: 'Shale Grey',
            pricePerMetre: 115,
            runs: [],
            gates: [],
            date: new Date().toISOString().slice(0, 10)
          };
          this.addRun();
        } else {
          this.syncHeaderFromJob();
          if (this.job.runs.length > 0 && !this.currentRunId) {
            this.currentRunId = this.job.runs[0].id;
          }
        }

        this.updateProfileDropdown();
        this.render();
      },

      // ‚îÄ‚îÄ Colour dropdown (Section 9.3) ‚îÄ‚îÄ
      populateColourDropdown() {
        const select = document.getElementById('colour');
        let html = '<optgroup label="‚îÄ‚îÄ Stock ‚îÄ‚îÄ">';
        COLOURS_STOCK.forEach(c => {
          html += `<option value="${c.name}" data-hex="${c.hex}">${c.name}</option>`;
        });
        html += '</optgroup><optgroup label="‚îÄ‚îÄ Special Order ‚îÄ‚îÄ">';
        COLOURS_SPECIAL.forEach(c => {
          html += `<option value="${c.name}" data-hex="${c.hex}">${c.name} (SO)</option>`;
        });
        html += '</optgroup>';
        select.innerHTML = html;
      },

      // ‚îÄ‚îÄ Profile dropdown (Section 4B) ‚îÄ‚îÄ
      updateProfileDropdown() {
        const select = document.getElementById('profile');
        const supplierData = SUPPLIER_PROFILES[this.job.supplier];
        select.innerHTML = supplierData.profiles.map(p =>
          `<option value="${p}" ${p === this.job.profile ? 'selected' : ''}>${p}</option>`
        ).join('');
        // If current profile is not valid for new supplier, reset to default
        if (!supplierData.profiles.includes(this.job.profile)) {
          this.job.profile = supplierData.profiles[0];
          select.value = this.job.profile;
        }
      },

      bindHeaderInputs() {
        document.getElementById('jobRef').addEventListener('input', (e) => {
          this.job.ref = e.target.value;
          this.save();
        });
        document.getElementById('client').addEventListener('input', (e) => {
          this.job.client = e.target.value;
          this.save();
        });
        document.getElementById('address').addEventListener('input', (e) => {
          this.job.address = e.target.value;
          this.save();
        });
        document.getElementById('supplier').addEventListener('change', (e) => {
          this.job.supplier = e.target.value;
          this.updateProfileDropdown();
          this.recalculateAll();
          this.save();
        });
        document.getElementById('profile').addEventListener('change', (e) => {
          this.job.profile = e.target.value;
          this.save();
        });
        document.getElementById('colour').addEventListener('change', (e) => {
          this.job.colour = e.target.value;
          this.save();
        });
        document.getElementById('pricePerMetre').addEventListener('input', (e) => {
          this.job.pricePerMetre = parseFloat(e.target.value) || 0;
          this.updateStats();
          this.save();
        });
      },

      syncHeaderFromJob() {
        document.getElementById('jobRef').value = this.job.ref || '';
        document.getElementById('client').value = this.job.client || '';
        document.getElementById('address').value = this.job.address || '';
        document.getElementById('supplier').value = this.job.supplier || 'RNR';
        document.getElementById('colour').value = this.job.colour || 'Shale Grey';
        document.getElementById('pricePerMetre').value = this.job.pricePerMetre || 115;
      },

      // ‚îÄ‚îÄ Section 3.5: Panel width by supplier ‚îÄ‚îÄ
      getPanelWidthMm() {
        return SUPPLIER_PROFILES[this.job.supplier].panelWidth;
      },

      getPanelWidthM() {
        return this.getPanelWidthMm() / 1000;
      },

      // ‚îÄ‚îÄ Section 6.1: Auto-calculate panel count from run length ‚îÄ‚îÄ
      calcPanelCount(lengthM) {
        if (!lengthM || lengthM <= 0) return 0;
        const lengthMm = lengthM * 1000;
        return Math.ceil(lengthMm / this.getPanelWidthMm());
      },

      // ‚îÄ‚îÄ Section 6.3: Post height per-post (between two panels) ‚îÄ‚îÄ
      getPostHeight(leftPanel, rightPanel) {
        let leftTotal = 0, rightTotal = 0;
        let leftLookup = null, rightLookup = null;

        if (leftPanel) {
          leftTotal = leftPanel.height + leftPanel.retaining;
          leftLookup = lookupPost(leftPanel.height, leftPanel.retaining);
        }
        if (rightPanel) {
          rightTotal = rightPanel.height + rightPanel.retaining;
          rightLookup = lookupPost(rightPanel.height, rightPanel.retaining);
        }

        // Use whichever side demands the taller post
        let postSize = 2400;
        let patio = false;

        if (leftLookup && rightLookup) {
          postSize = Math.max(leftLookup.post, rightLookup.post);
          patio = leftLookup.patio || rightLookup.patio;
        } else if (leftLookup) {
          postSize = leftLookup.post;
          patio = leftLookup.patio;
        } else if (rightLookup) {
          postSize = rightLookup.post;
          patio = rightLookup.patio;
        }

        return { postSize, patio };
      },

      // ‚îÄ‚îÄ Sync panels to match calculated panel count ‚îÄ‚îÄ
      syncPanels(run) {
        const targetCount = this.calcPanelCount(run.length);
        if (targetCount === 0) {
          run.panels = [];
          return;
        }

        while (run.panels.length < targetCount) {
          run.panels.push({
            id: 'panel-' + Date.now() + '-' + Math.random().toString(36).slice(2, 6),
            height: run.sheetHeight,
            retaining: 0,
            ground: 'level'
          });
        }

        // If decreased, remove from end (but only excess)
        if (run.panels.length > targetCount) {
          run.panels = run.panels.slice(0, targetCount);
        }
      },

      // ‚îÄ‚îÄ Compute derived values per panel (not stored, used for display) ‚îÄ‚îÄ
      getPanelDerived(panel) {
        const plinths = panel.retaining / 150;
        const totalHeight = panel.height + panel.retaining;
        const lookup = lookupPost(panel.height, panel.retaining);
        return {
          plinths,
          totalHeight,
          postSize: lookup.post,
          patio: lookup.patio,
          needsPatioTube: plinths >= 3 && plinths <= 5
        };
      },

      // ‚îÄ‚îÄ Compute post array for a run (posts = panels + 1) ‚îÄ‚îÄ
      getRunPosts(run) {
        const posts = [];
        for (let i = 0; i <= run.panels.length; i++) {
          const leftPanel = i > 0 ? run.panels[i - 1] : null;
          const rightPanel = i < run.panels.length ? run.panels[i] : null;
          posts.push(this.getPostHeight(leftPanel, rightPanel));
        }
        return posts;
      },

      recalculateAll() {
        this.job.runs.forEach(run => this.syncPanels(run));
        this.render();
      },

      // ‚îÄ‚îÄ Runs ‚îÄ‚îÄ
      addRun() {
        const idx = this.job.runs.length;
        const name = idx < RUN_NAME_CYCLE.length ? RUN_NAME_CYCLE[idx] : 'Custom';
        const run = {
          id: 'run-' + Date.now(),
          name: name,
          length: 0,
          sheetHeight: 1800,
          extension: 'none',
          panels: []
        };
        this.job.runs.push(run);
        this.currentRunId = run.id;
        this.save();
        this.render();
      },

      deleteRun(runId) {
        if (this.job.runs.length <= 1) {
          alert('Must have at least one run.');
          return;
        }
        if (!confirm('Delete this run?')) return;
        this.job.runs = this.job.runs.filter(r => r.id !== runId);
        if (this.currentRunId === runId) {
          this.currentRunId = this.job.runs[0].id;
        }
        this.save();
        this.render();
      },

      switchRun(runId) {
        this.currentRunId = runId;
        this.render();
      },

      updateRunSettings(runId, field, value) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        if (field === 'name') {
          run.name = value;
        } else if (field === 'length') {
          run.length = parseFloat(value) || 0;
          this.syncPanels(run);
        } else if (field === 'sheetHeight') {
          run.sheetHeight = parseInt(value);
        } else if (field === 'extension') {
          run.extension = value;
        }

        this.save();
        this.render();
      },

      applyHeightToAll(runId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;
        run.panels.forEach(p => { p.height = run.sheetHeight; });
        this.save();
        this.render();
      },

      updatePanel(runId, panelIdx, field, value) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run || !run.panels[panelIdx]) return;

        const panel = run.panels[panelIdx];
        if (field === 'height') {
          panel.height = parseInt(value);
        } else if (field === 'retaining') {
          panel.retaining = parseInt(value);
        }

        this.save();
        this.render();
      },

      deletePanel(runId, panelIdx) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run || run.panels.length <= 1) return;
        run.panels.splice(panelIdx, 1);
        this.save();
        this.render();
      },

      applyQuickRetaining(runId) {
        const run = this.job.runs.find(r => r.id === runId);
        if (!run) return;

        const startPanel = parseInt(document.getElementById(`qr-start-${runId}`).value);
        const endPanel = parseInt(document.getElementById(`qr-end-${runId}`).value);
        const retaining = parseInt(document.getElementById(`qr-retaining-${runId}`).value);

        if (startPanel < 1 || endPanel > run.panels.length || startPanel > endPanel) {
          alert('Invalid panel range.');
          return;
        }

        for (let i = startPanel - 1; i < endPanel; i++) {
          run.panels[i].retaining = retaining;
        }

        this.save();
        this.render();
      },

      // ‚îÄ‚îÄ Gates ‚îÄ‚îÄ
      addGate() {
        if (!this.job.runs.length) return;
        this.job.gates.push({
          id: 'gate-' + Date.now(),
          type: 'pedestrian',
          width: 900,
          runIndex: 0,
          afterPanel: 1
        });
        this.save();
        this.render();
      },

      updateGate(gateId, field, value) {
        const gate = this.job.gates.find(g => g.id === gateId);
        if (!gate) return;
        if (field === 'type') gate.type = value;
        else if (field === 'width') gate.width = parseInt(value) || 900;
        else if (field === 'runIndex') gate.runIndex = parseInt(value);
        else if (field === 'afterPanel') gate.afterPanel = parseInt(value);
        this.save();
        this.render();
      },

      deleteGate(gateId) {
        this.job.gates = this.job.gates.filter(g => g.id !== gateId);
        this.save();
        this.render();
      },

      // ‚îÄ‚îÄ Section 11: Compliance warnings ‚îÄ‚îÄ
      getComplianceWarnings() {
        const warnings = [];
        this.job.runs.forEach(run => {
          run.panels.forEach((panel, idx) => {
            const plinths = panel.retaining / 150;
            if (plinths >= 6) {
              warnings.push({
                type: 'stop',
                msg: `${run.name} P${idx + 1}: ${panel.retaining}mm retaining (${plinths} plinths) ‚Äî STOP: Exceeds Colorbond plinth capacity. Requires post & panel retaining system.`
              });
            }
            if (panel.retaining > 500) {
              warnings.push({
                type: 'warn',
                msg: `${run.name} P${idx + 1}: Retaining >${500}mm requires Building Permit + Engineer Cert in WA.`
              });
            }
          });
        });
        return warnings;
      },

      // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
      updateStats() {
        let totalPanels = 0;
        let totalPosts = 0;
        let totalMetres = 0;
        let totalPlinths = 0;
        let plinthPanelCount = 0;
        const panelWidthM = this.getPanelWidthM();
        const panelWidthMm = this.getPanelWidthMm();

        this.job.runs.forEach(run => {
          const panelCount = run.panels.length;
          totalPanels += panelCount;
          totalPosts += panelCount + 1;
          totalMetres += run.length || 0;
          run.panels.forEach(p => {
            const pl = p.retaining / 150;
            totalPlinths += pl;
            if (pl > 0) plinthPanelCount++;
          });
        });

        // Corner post sharing: if >1 run, subtract shared corners
        // Simple approximation: subtract (runs - 1) for connected runs
        // TODO: proper corner handling needs run-connection data

        const estimate = totalMetres * this.job.pricePerMetre * 1.1;

        document.getElementById('statMetres').textContent =
          totalMetres > 0 ? `${totalMetres.toFixed(1)}m / ${totalPanels} √ó ${panelWidthMm}mm` : '0.0m';
        document.getElementById('statPanels').textContent = totalPanels;
        document.getElementById('statPosts').textContent = totalPosts;
        document.getElementById('statPlinths').textContent =
          totalPlinths > 0 ? `${totalPlinths} (across ${plinthPanelCount} panels)` : '0';
        document.getElementById('statCost').textContent =
          estimate > 0 ? `$${Math.round(estimate).toLocaleString()} EST.` : '$0';
      },

      // ‚îÄ‚îÄ New Job ‚îÄ‚îÄ
      newJob() {
        if (!confirm('Start a new job? This will clear all current data.')) return;
        localStorage.removeItem('fenceJob');
        this.job = null;
        this.currentRunId = null;
        this.init();
      },

      // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
      render() {
        this.renderRunTabs();
        this.renderRunContent();
        this.updateStats();
      },

      renderRunTabs() {
        const tabsHtml = this.job.runs.map(run => {
          const panelCount = run.panels.length;
          return `<div class="run-tab ${run.id === this.currentRunId ? 'active' : ''}"
                       onclick="app.switchRun('${run.id}')">
                    ${run.name}${panelCount > 0 ? ` (${panelCount})` : ''}
                  </div>`;
        }).join('');

        document.getElementById('runTabs').innerHTML = `
          ${tabsHtml}
          <button class="add-run-btn" onclick="app.addRun()">+ Add Run</button>
        `;
      },

      renderRunContent() {
        const run = this.job.runs.find(r => r.id === this.currentRunId);
        if (!run) {
          document.getElementById('runContent').innerHTML =
            '<p style="padding: 20px; color: #4C6A70;">No run selected. Click "+ Add Run" to begin.</p>';
          return;
        }

        // Warnings
        const warnings = this.getComplianceWarnings();
        let warningsHtml = '';
        warnings.forEach(w => {
          const cls = w.type === 'stop' ? '' : 'warn';
          warningsHtml += `<div class="compliance-warning ${cls}">
            <h4>${w.type === 'stop' ? 'üî¥ STOP' : '‚ö†Ô∏è Warning'}</h4>
            <p>${w.msg}</p>
          </div>`;
        });

        // Compute posts for this run
        const posts = this.getRunPosts(run);

        // Panel table rows
        const panelRows = run.panels.map((panel, idx) => {
          const derived = this.getPanelDerived(panel);
          // Post for this panel = the post to the RIGHT of the panel (post index idx+1)
          // But per spec, "Post" column shows the calculated post height.
          // Post at position idx sits between panel idx-1 and panel idx.
          // We'll show the max post relevant to this panel (max of left and right post).
          const leftPost = posts[idx];
          const rightPost = posts[idx + 1];
          const maxPost = Math.max(leftPost.postSize, rightPost.postSize);
          const anyPatio = leftPost.patio || rightPost.patio;

          const totalClass = derived.totalHeight > 1800 ? 'total-elevated' : 'total-standard';
          const postDisplay = anyPatio
            ? `<span class="post-patio">${maxPost}‚Ä†</span>`
            : `${maxPost}`;

          // Step indicator (compare retaining with neighbors)
          let step = '‚Äî';
          if (idx > 0) {
            const prev = run.panels[idx - 1];
            if (panel.retaining > prev.retaining) step = '‚Üë';
            else if (panel.retaining < prev.retaining) step = '‚Üì';
          }

          return `<tr>
            <td class="col-pnum">P${idx + 1}</td>
            <td class="col-ht">
              <select onchange="app.updatePanel('${run.id}', ${idx}, 'height', this.value)">
                ${SHEET_HEIGHTS.map(h =>
                  `<option value="${h}" ${panel.height === h ? 'selected' : ''}>${h / 100}</option>`
                ).join('')}
              </select>
            </td>
            <td class="col-ret">
              <select onchange="app.updatePanel('${run.id}', ${idx}, 'retaining', this.value)">
                ${RETAINING_OPTIONS.map(r =>
                  `<option value="${r}" ${panel.retaining === r ? 'selected' : ''}>${r}</option>`
                ).join('')}
              </select>
            </td>
            <td class="col-pl">${derived.plinths}</td>
            <td class="col-step">${step}</td>
            <td class="col-total ${totalClass}">${derived.totalHeight}</td>
            <td class="col-post">${postDisplay}</td>
            <td class="col-del"><button class="delete-panel-btn" onclick="app.deletePanel('${run.id}', ${idx})" title="Delete panel">&times;</button></td>
          </tr>`;
        }).join('');

        // Extension dropdown value mapping
        const extOptions = [
          { value: 'none', label: 'None' },
          { value: 'slat', label: 'Slat' },
          { value: 'solid_fill', label: 'Solid Fill' },
          { value: 'lattice', label: 'Lattice' }
        ];

        // Gates section
        const gatesHtml = (this.job.gates || []).map(gate => `
          <div class="gate-row">
            <select onchange="app.updateGate('${gate.id}', 'type', this.value)">
              <option value="pedestrian" ${gate.type === 'pedestrian' ? 'selected' : ''}>Pedestrian</option>
              <option value="double" ${gate.type === 'double' ? 'selected' : ''}>Double</option>
              <option value="sliding" ${gate.type === 'sliding' ? 'selected' : ''}>Sliding</option>
            </select>
            <input type="number" value="${gate.width}" min="600" step="100" style="width:70px;"
                   onchange="app.updateGate('${gate.id}', 'width', this.value)" placeholder="mm">
            <select onchange="app.updateGate('${gate.id}', 'runIndex', this.value)">
              ${this.job.runs.map((r, ri) =>
                `<option value="${ri}" ${gate.runIndex === ri ? 'selected' : ''}>${r.name}</option>`
              ).join('')}
            </select>
            <label style="font-size:11px;">After P</label>
            <input type="number" value="${gate.afterPanel}" min="1" max="${run.panels.length}" style="width:50px;"
                   onchange="app.updateGate('${gate.id}', 'afterPanel', this.value)">
            <button class="delete-panel-btn" onclick="app.deleteGate('${gate.id}')" title="Delete gate">&times;</button>
          </div>
        `).join('');

        document.getElementById('runContent').innerHTML = `
          ${warningsHtml}

          <div class="run-settings">
            <h3>Run Settings</h3>
            <div class="run-settings-grid">
              <div class="form-group">
                <label>Name</label>
                <input type="text" value="${run.name}"
                       onchange="app.updateRunSettings('${run.id}', 'name', this.value)">
              </div>
              <div class="form-group">
                <label>Length (m)</label>
                <input type="number" value="${run.length || ''}" min="0" step="0.5" placeholder="0.0"
                       onchange="app.updateRunSettings('${run.id}', 'length', this.value)">
              </div>
              <div class="form-group">
                <label>Sheet Height</label>
                <select onchange="app.updateRunSettings('${run.id}', 'sheetHeight', this.value)">
                  ${SHEET_HEIGHTS.map(h =>
                    `<option value="${h}" ${run.sheetHeight === h ? 'selected' : ''}>${h}mm</option>`
                  ).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Extension</label>
                <select onchange="app.updateRunSettings('${run.id}', 'extension', this.value)">
                  ${extOptions.map(o =>
                    `<option value="${o.value}" ${run.extension === o.value ? 'selected' : ''}>${o.label}</option>`
                  ).join('')}
                </select>
              </div>
            </div>
            <div class="run-settings-actions">
              <button class="btn-orange" onclick="app.applyHeightToAll('${run.id}')">Apply Height to All</button>
              <button class="btn-delete" onclick="app.deleteRun('${run.id}')">Delete Run</button>
            </div>
          </div>

          <div class="quick-retaining">
            <h3>Quick Retaining Tool</h3>
            <div class="quick-retaining-row">
              <div class="form-group">
                <label>From Panel</label>
                <input type="number" id="qr-start-${run.id}" min="1" max="${run.panels.length}" value="1" style="width:60px;">
              </div>
              <div class="form-group">
                <label>To Panel</label>
                <input type="number" id="qr-end-${run.id}" min="1" max="${run.panels.length}" value="${run.panels.length}" style="width:60px;">
              </div>
              <div class="form-group">
                <label>Retaining (mm)</label>
                <select id="qr-retaining-${run.id}">
                  ${RETAINING_OPTIONS.map(r =>
                    `<option value="${r}">${r}</option>`
                  ).join('')}
                </select>
              </div>
              <button class="btn-orange" onclick="app.applyQuickRetaining('${run.id}')">Apply</button>
            </div>
          </div>

          <div class="panel-table-section">
            <h3>Panel Table</h3>
            <div class="panel-table-wrap">
              <table class="panel-table">
                <thead>
                  <tr>
                    <th>P#</th>
                    <th>Ht</th>
                    <th>Ret</th>
                    <th>Pl</th>
                    <th>Stp</th>
                    <th>Tot</th>
                    <th>Post</th>
                    <th>&times;</th>
                  </tr>
                </thead>
                <tbody>
                  ${panelRows}
                </tbody>
              </table>
            </div>
          </div>

          <div class="gates-section">
            <h3>Gates</h3>
            ${gatesHtml || '<p style="font-size:12px; color:#4C6A70;">No gates added.</p>'}
            <button class="btn-orange" style="margin-top:8px;" onclick="app.addGate()">+ Add Gate</button>
          </div>
        `;
      },

      generateOutputs() {
        alert('Output generation not yet implemented.');
      },

      // ‚îÄ‚îÄ LocalStorage ‚îÄ‚îÄ
      save() {
        localStorage.setItem('fenceJob', JSON.stringify(this.job));
        const ind = document.getElementById('savedIndicator');
        if (ind) {
          ind.textContent = 'Saved';
          ind.style.opacity = '1';
          setTimeout(() => { ind.style.opacity = '0.7'; }, 1000);
        }
      },

      loadFromStorage() {
        const saved = localStorage.getItem('fenceJob');
        if (saved) {
          try {
            this.job = JSON.parse(saved);
            // Migration: ensure new fields exist
            if (!this.job.gates) this.job.gates = [];
            this.job.runs.forEach(run => {
              if (run.sheetHeight === undefined) run.sheetHeight = run.defaultHeight || 1800;
              if (run.extension === undefined || run.extension === null) run.extension = 'none';
              run.panels.forEach(p => {
                if (p.ground === undefined) p.ground = 'level';
              });
            });
            if (this.job.runs.length > 0 && !this.currentRunId) {
              this.currentRunId = this.job.runs[0].id;
            }
          } catch (e) {
            this.job = null;
          }
        }
      }
    };

    window.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>
