<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureWorks WA - Fence Designer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #d1fae5;
            --accent: #d97706;
            --accent-light: #fef3c7;
            --bg: #ffffff;
            --surface: #f8fafc;
            --surface-2: #f1f5f9;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --danger: #dc2626;
            --info: #0284c7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--surface);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
        }

        body { min-height: 100vh; }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #065f46 0%, #059669 100%);
            padding: 0 24px;
            display: flex;
            align-items: center;
            height: 64px;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .logo-mark {
            width: 42px;
            height: 42px;
            background: white;
            border-radius: 10px;
            display: grid;
            place-items: center;
            color: var(--primary);
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .logo-text { color: white; }
        .logo-text .brand { font-weight: 700; font-size: 17px; letter-spacing: -0.3px; }
        .logo-text .sub { font-size: 11px; opacity: 0.85; font-weight: 500; }

        .header-sep { width: 1px; height: 32px; background: rgba(255,255,255,0.25); }

        .job-fields { display: flex; gap: 12px; align-items: center; flex: 1; }

        .field { display: flex; flex-direction: column; gap: 2px; }
        .field label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.75); font-weight: 600; }
        .field input, .field select { border: none; border-radius: 6px; padding: 7px 10px; font-size: 13px; background: rgba(255,255,255,0.95); color: var(--text); font-weight: 500; }

        .header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .save-status { font-size: 12px; color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 20px; font-weight: 500; }
        .btn-new { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }

        /* ===== MAIN LAYOUT ===== */
        .main { display: flex; height: calc(100vh - 64px); }

        /* ===== LEFT PANEL ===== */
        .panel-left { width: 420px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }

        .runs-header { padding: 16px; border-bottom: 1px solid var(--border); background: var(--surface); }
        .runs-tabs { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .run-tab { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 2px solid var(--border); background: white; color: var(--text-secondary); }
        .run-tab.active { background: var(--primary); border-color: var(--primary); color: white; }
        .run-tab .num { opacity: 0.7; margin-left: 4px; font-weight: 500; }
        .btn-add-run { padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 2px dashed var(--primary); background: var(--primary-light); color: var(--primary); }

        .run-settings { padding: 16px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: white; }
        .setting { display: flex; flex-direction: column; gap: 4px; }
        .setting label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
        .setting input, .setting select { padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; background: white; color: var(--text); font-weight: 500; }
        .setting input:focus, .setting select:focus { outline: none; border-color: var(--primary); }
        .length-group { display: flex; gap: 6px; }
        .length-group input { flex: 1; min-width: 0; }
        .length-group select { width: 58px; padding: 10px 6px; }

        .run-actions { grid-column: 1 / -1; display: flex; gap: 10px; padding-top: 4px; flex-wrap: wrap; }
        .btn { padding: 9px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 2px solid var(--border); background: white; color: var(--text-secondary); }
        .btn:hover { border-color: var(--text-secondary); }
        .btn-danger { color: var(--danger); border-color: #fecaca; }
        .btn-danger:hover { background: #fee2e2; border-color: var(--danger); }
        .btn-accent { color: var(--accent); border-color: var(--accent-light); background: var(--accent-light); }
        .btn-accent:hover { background: var(--accent); color: white; }

        /* ===== QUICK RETAINING TOOL ===== */
        .quick-ret { grid-column: 1 / -1; background: var(--accent-light); border-radius: 8px; padding: 12px; margin-top: 4px; }
        .quick-ret-title { font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
        .quick-ret-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .quick-ret-row span { font-size: 12px; color: var(--text-secondary); }
        .quick-ret-row select, .quick-ret-row input { padding: 6px 10px; border: 2px solid var(--border); border-radius: 6px; font-size: 13px; background: white; }
        .quick-ret-row input { width: 50px; }
        .quick-ret-row button { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; background: var(--accent); color: white; }

        /* ===== PANEL TABLE ===== */
        .table-wrap { flex: 1; overflow-y: auto; }
        .panel-table { width: 100%; border-collapse: collapse; }
        .panel-table th { position: sticky; top: 0; background: var(--surface-2); padding: 10px 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .panel-table td { padding: 6px; border-bottom: 1px solid var(--border); background: white; vertical-align: middle; }
        .panel-table tr:hover td { background: var(--primary-light); }
        .panel-table tr.selected td { background: #a7f3d0; }

        .p-num { font-weight: 700; color: var(--primary); cursor: pointer; font-size: 13px; }
        .p-num:hover { text-decoration: underline; }

        .panel-table select { padding: 4px 6px; border: 2px solid transparent; border-radius: 4px; font-size: 12px; background: transparent; color: var(--text); font-weight: 500; width: 100%; }
        .panel-table select:hover { background: var(--surface); border-color: var(--border); }
        .panel-table select:focus { outline: none; border-color: var(--primary); background: white; }

        .ret-visual { display: flex; gap: 2px; }
        .ret-block { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 2px; }
        .ret-block.empty { background: var(--border); }

        .step-icon { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .step-icon.down { background: #fee2e2; color: var(--danger); }
        .step-icon.up { background: var(--primary-light); color: var(--primary); }
        .step-icon.level { background: var(--surface-2); color: var(--text-muted); }

        .total-ht { font-weight: 700; color: var(--info); font-size: 11px; }
        .post-ht { font-weight: 700; color: var(--primary); font-size: 11px; }
        .post-ht.patio { color: var(--accent); }
        .post-ht.patio::after { content: 'â€ '; font-size: 9px; margin-left: 1px; }

        .btn-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 6px; font-size: 14px; border-radius: 4px; }
        .btn-remove:hover { background: #fee2e2; color: var(--danger); }

        .add-row td { padding: 10px; text-align: center; }
        .btn-add-panel { padding: 6px 14px; border: 2px solid var(--primary); border-radius: 6px; background: var(--primary-light); color: var(--primary); font-size: 11px; font-weight: 600; cursor: pointer; }

        /* ===== GATES ===== */
        .gates-section { padding: 16px; border-top: 2px solid var(--border); background: var(--surface); }
        .gates-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gates-header h4 { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .gate-row { display: flex; align-items: center; gap: 6px; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); flex-wrap: wrap; }
        .gate-row select, .gate-row input { padding: 6px 8px; border: 2px solid var(--border); border-radius: 6px; font-size: 12px; background: white; }
        .gate-row input { width: 60px; }
        .gate-row span { font-size: 11px; color: var(--text-muted); }

        /* ===== RIGHT PANEL ===== */
        .panel-right { flex: 1; display: flex; flex-direction: column; background: var(--surface-2); }

        .viz-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: white; border-bottom: 1px solid var(--border); gap: 16px; flex-wrap: wrap; }
        .view-tabs { display: flex; background: var(--surface-2); padding: 4px; border-radius: 10px; gap: 4px; }
        .view-tab { padding: 10px 18px; border: none; background: transparent; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
        .view-tab.active { background: white; color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }

        .stats { display: flex; gap: 20px; align-items: center; }
        .stat { text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .stat-lbl { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .stat-price { background: var(--accent-light); padding: 8px 16px; border-radius: 8px; }
        .stat-price .stat-val { color: var(--accent); }
        .stat-calc { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

        .btn-generate { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(5,150,105,0.35); }

        /* ===== CANVAS ===== */
        .viz-area { flex: 1; position: relative; overflow: hidden; }
        .canvas-box { position: absolute; inset: 0; }
        #profileCanvas { display: block; }
        #threeBox { display: none; width: 100%; height: 100%; }
        .viz-area.mode-3d #profileCanvas { display: none; }
        .viz-area.mode-3d #threeBox { display: block; }
        .legend { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,0.95); padding: 10px 14px; border-radius: 8px; font-size: 12px; color: var(--text-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .hint-3d { position: absolute; bottom: 12px; right: 12px; background: rgba(255,255,255,0.95); padding: 10px 14px; border-radius: 8px; font-size: 12px; color: var(--text-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
        .viz-area.mode-3d .hint-3d { display: block; }

        /* ===== MODAL ===== */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 1000; }
        .modal-bg.open { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 16px; width: 90%; max-width: 620px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-top { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-tabs { display: flex; gap: 4px; }
        .modal-tab { padding: 8px 16px; border: none; background: transparent; border-radius: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; }
        .modal-tab.active { background: var(--primary-light); color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 22px; color: var(--text-muted); cursor: pointer; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .output-pre { font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 11px; line-height: 1.5; white-space: pre-wrap; background: var(--surface-2); padding: 16px; border-radius: 8px; border: 1px solid var(--border); }
        .modal-bottom { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .m-btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .m-btn-sec { background: white; border: 2px solid var(--border); color: var(--text); }
        .m-btn-pri { background: var(--primary); border: none; color: white; }
    </style>
</head>
<body>

<header class="header">
    <div class="logo">
        <div class="logo-mark">SW</div>
        <div class="logo-text">
            <div class="brand">SecureWorks WA</div>
            <div class="sub">Fence Designer Pro</div>
        </div>
    </div>
    <div class="header-sep"></div>
    <div class="job-fields">
        <div class="field">
            <label>Job Ref</label>
            <input type="text" id="jobRef" style="width:85px" onchange="saveJob()">
        </div>
        <div class="field">
            <label>Client</label>
            <input type="text" id="clientName" placeholder="Client name" style="width:130px" onchange="saveJob()">
        </div>
        <div class="field">
            <label>Address</label>
            <input type="text" id="address" placeholder="Property address" style="width:200px" onchange="saveJob()">
        </div>
        <div class="header-sep"></div>
        <div class="field">
            <label>Supplier</label>
            <select id="supplier" onchange="onSupplierChange()">
                <option value="RNR">RNR (2380mm)</option>
                <option value="Metroll">Metroll (2365mm)</option>
                <option value="Lysaght">Lysaght (2360mm)</option>
            </select>
        </div>
        <div class="field">
            <label>Colour</label>
            <select id="colour" onchange="onColourChange()">
                <option value="Shale Grey">Shale Grey</option>
                <option value="Monument">Monument</option>
                <option value="Woodland Grey">Woodland Grey</option>
                <option value="Basalt">Basalt</option>
                <option value="Surfmist">Surfmist</option>
                <option value="Dune">Dune</option>
                <option value="Paperbark">Paperbark</option>
            </select>
        </div>
        <div class="field">
            <label>$/Metre</label>
            <input type="number" id="pricePerM" value="115" style="width:70px" onchange="updateStats()">
        </div>
    </div>
    <div class="header-actions">
        <span class="save-status" id="saveStatus">Saved</span>
        <button class="btn-new" onclick="newJob()">New Job</button>
    </div>
</header>

<div class="main">
    <div class="panel-left">
        <div class="runs-header">
            <div class="runs-tabs">
                <span id="runTabs"></span>
                <button class="btn-add-run" onclick="addRun()">+ Add Run</button>
            </div>
        </div>

        <div class="run-settings">
            <div class="setting">
                <label>Run Name</label>
                <input type="text" id="runName" onchange="updateRunName()">
            </div>
            <div class="setting">
                <label>Total Length</label>
                <div class="length-group">
                    <input type="number" id="runLength" step="0.1" onchange="updateRunLength()">
                    <select id="lengthUnit" onchange="updateRunLength()">
                        <option value="m">m</option>
                        <option value="mm">mm</option>
                    </select>
                </div>
            </div>
            <div class="setting">
                <label>Fence Height</label>
                <select id="defaultHeight" onchange="updateDefaultHeight()">
                    <option value="1200">1200mm</option>
                    <option value="1500">1500mm</option>
                    <option value="1800" selected>1800mm</option>
                    <option value="2100">2100mm</option>
                </select>
            </div>
            <div class="setting">
                <label>Extension</label>
                <select id="extension" onchange="updateExtension()">
                    <option value="0">None</option>
                    <option value="150">150mm Solid</option>
                    <option value="300">300mm Lattice</option>
                </select>
            </div>
            <div class="run-actions">
                <button class="btn" onclick="applyHeightToAll()">Apply Height to All</button>
                <button class="btn btn-danger" onclick="deleteRun()">Delete Run</button>
            </div>

            <!-- Quick Retaining Tool -->
            <div class="quick-ret">
                <div class="quick-ret-title">âš¡ Quick Retaining</div>
                <div class="quick-ret-row">
                    <span>Panels</span>
                    <input type="number" id="retFromPanel" value="1" min="1">
                    <span>to</span>
                    <input type="number" id="retToPanel" value="3" min="1">
                    <span>â†’</span>
                    <select id="retValue">
                        <option value="0">0mm</option>
                        <option value="150">150mm</option>
                        <option value="300">300mm</option>
                        <option value="450">450mm</option>
                        <option value="600">600mm</option>
                        <option value="750">750mm</option>
                    </select>
                    <button onclick="applyQuickRetaining()">Apply</button>
                </div>
            </div>
        </div>

        <div class="table-wrap">
            <table class="panel-table">
                <thead>
                    <tr>
                        <th style="width:36px">P#</th>
                        <th style="width:55px">Height</th>
                        <th style="width:55px">Ret</th>
                        <th style="width:40px"></th>
                        <th style="width:28px">Stp</th>
                        <th style="width:45px">Tot</th>
                        <th style="width:45px">Post</th>
                        <th style="width:24px"></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="gates-section">
            <div class="gates-header">
                <h4>Gates</h4>
                <button class="btn" onclick="addGate()">+ Add Gate</button>
            </div>
            <div id="gatesBox"></div>
        </div>
    </div>

    <div class="panel-right">
        <div class="viz-toolbar">
            <div class="view-tabs">
                <button class="view-tab active" id="tabProfile" onclick="showView('profile')">Profile View</button>
                <button class="view-tab" id="tab3d" onclick="showView('3d')">3D View</button>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-val" id="sMetres">0</div>
                    <div class="stat-lbl">Metres</div>
                    <div class="stat-calc" id="sCalc">0 Ã— 2380mm</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="sPanels">0</div>
                    <div class="stat-lbl">Panels</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="sPosts">0</div>
                    <div class="stat-lbl">Posts</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="sRet">0</div>
                    <div class="stat-lbl">Plinths</div>
                </div>
                <div class="stat stat-price">
                    <div class="stat-val" id="sPrice">$0</div>
                    <div class="stat-lbl">Est. Total</div>
                </div>
            </div>
            <button class="btn-generate" onclick="showOutputs()">Generate Outputs</button>
        </div>

        <div class="viz-area" id="vizArea">
            <div class="canvas-box">
                <canvas id="profileCanvas"></canvas>
                <div id="threeBox"></div>
            </div>
            <div class="legend">Click panel # to select Â· <span style="color:#d97706">â€ </span> = patio tube (3+ plinths)</div>
            <div class="hint-3d">ðŸ–± Drag to rotate Â· Scroll to zoom</div>
        </div>
    </div>
</div>

<div class="modal-bg" id="modalBg">
    <div class="modal">
        <div class="modal-top">
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab(this,'material')">Material Order</button>
                <button class="modal-tab" onclick="switchTab(this,'work')">Work Order</button>
                <button class="modal-tab" onclick="switchTab(this,'quote')">Quote</button>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <pre class="output-pre" id="outputPre"></pre>
        </div>
        <div class="modal-bottom">
            <button class="m-btn m-btn-sec" onclick="closeModal()">Close</button>
            <button class="m-btn m-btn-pri" onclick="copyOutput(event)">ðŸ“‹ Copy</button>
        </div>
    </div>
</div>

<script>
// ========== CONFIG ==========
const SUPPLIERS = {
    'RNR': { width: 2380, name: 'RnR Fencing', profile: 'RnR Trimclad Equivalent' },
    'Metroll': { width: 2365, name: 'Metroll', profile: 'Metroll Trimdek' },
    'Lysaght': { width: 2360, name: 'Lysaght', profile: 'Lysaght Neetascreen' }
};

const COLOURS = {
    'Shale Grey': '#B2ADA3', 'Monument': '#54504A', 'Woodland Grey': '#5D5E50',
    'Basalt': '#6E6E68', 'Surfmist': '#E8E4DA', 'Dune': '#B5A78C', 'Paperbark': '#C6BDAC'
};

const POST_SIZES = [2400, 2700, 3000, 3300, 3600];
const POST_FOOTING_MM = 600;
const GST_RATE = 0.1;
const DEFAULT_PRICE_PER_M = 115;
const SCALE_3D = 0.55;

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function parsePricePerM() {
    const val = parseFloat(document.getElementById('pricePerM')?.value);
    return Number.isFinite(val) ? val : DEFAULT_PRICE_PER_M;
}

// ========== STATE ==========
let job = { ref: '', client: '', address: '', supplier: 'RNR', colour: 'Shale Grey', date: new Date().toISOString().split('T')[0], runs: [], gates: [] };
let curRun = 0, selPanel = -1, curTab = 'material', dirty = false;
let scene, camera, renderer, threeReady = false, resizeObserver = null;

// ========== INIT ==========
function init() {
    const saved = localStorage.getItem('fenceJob_v12');
    if (saved) { try { job = JSON.parse(saved); curRun = 0; } catch(e) { console.error('Failed to parse saved job data:', e); createDefault(); } }
    else { createDefault(); }
    loadUI();
    renderAll();
    setupResize();
}

function createDefault() {
    job = { ref: 'SW' + Math.floor(1000 + Math.random() * 9000), client: '', address: '', supplier: 'RNR', colour: 'Shale Grey', date: new Date().toISOString().split('T')[0], runs: [], gates: [] };
    addRun('Rear', 19);
}

function loadUI() {
    document.getElementById('jobRef').value = job.ref;
    document.getElementById('clientName').value = job.client;
    document.getElementById('address').value = job.address;
    document.getElementById('supplier').value = job.supplier;
    document.getElementById('colour').value = job.colour;
}

function newJob() {
    if (dirty && !confirm('Discard changes?')) return;
    localStorage.removeItem('fenceJob_v12');
    createDefault(); loadUI(); curRun = 0; selPanel = -1; renderAll(); markSaved();
}

// ========== SAVE ==========
function saveJob() {
    job.ref = document.getElementById('jobRef').value;
    job.client = document.getElementById('clientName').value;
    job.address = document.getElementById('address').value;
    localStorage.setItem('fenceJob_v12', JSON.stringify(job));
    markSaved();
}

function autoSave() { localStorage.setItem('fenceJob_v12', JSON.stringify(job)); markSaved(); }
function markSaved() { dirty = false; document.getElementById('saveStatus').textContent = 'Saved'; }
function markDirty() { dirty = true; document.getElementById('saveStatus').textContent = 'Unsaved'; }

// ========== RUNS ==========
function addRun(name, len = 19) {
    const names = ['Rear','LHS','RHS','Front'];
    const used = job.runs.map(r => r.name);
    const defName = name || names.find(n => !used.includes(n)) || `Run ${job.runs.length+1}`;
    const pw = SUPPLIERS[job.supplier].width;
    const cnt = Math.ceil(len * 1000 / pw);
    const panels = [];
    for (let i = 0; i < cnt; i++) panels.push({ height: 1800, retaining: 0 });
    job.runs.push({ name: defName, length: cnt * pw, defaultHeight: 1800, extension: 0, panels });
    curRun = job.runs.length - 1;
    selPanel = -1;
    renderAll();
    autoSave();
}

function deleteRun() {
    if (job.runs.length <= 1) { alert('Need at least one run'); return; }
    if (!confirm(`Delete "${job.runs[curRun].name}"?`)) return;
    job.runs.splice(curRun, 1);
    curRun = Math.max(0, curRun - 1);
    selPanel = -1;
    renderAll();
    autoSave();
}

function selectRun(i) { curRun = i; selPanel = -1; renderAll(); }

function updateRunName() { job.runs[curRun].name = document.getElementById('runName').value; renderTabs(); autoSave(); }

function updateRunLength() {
    const val = parseFloat(document.getElementById('runLength').value) || 10;
    const unit = document.getElementById('lengthUnit').value;
    const mm = unit === 'm' ? val * 1000 : val;
    const pw = SUPPLIERS[job.supplier].width;
    const cnt = Math.ceil(mm / pw);
    const run = job.runs[curRun];
    while (run.panels.length < cnt) run.panels.push({ height: run.defaultHeight, retaining: 0 });
    while (run.panels.length > cnt) run.panels.pop();
    run.length = cnt * pw;
    document.getElementById('runLength').value = unit === 'm' ? (run.length/1000).toFixed(2) : run.length;
    // Update quick retaining max
    document.getElementById('retToPanel').max = run.panels.length;
    document.getElementById('retFromPanel').max = run.panels.length;
    renderAll();
    autoSave();
}

function updateDefaultHeight() { job.runs[curRun].defaultHeight = parseInt(document.getElementById('defaultHeight').value); autoSave(); }

function updateExtension() { job.runs[curRun].extension = parseInt(document.getElementById('extension').value) || 0; renderAll(); autoSave(); }

function applyHeightToAll() {
    const h = job.runs[curRun].defaultHeight;
    job.runs[curRun].panels.forEach(p => p.height = h);
    renderAll(); autoSave();
}

// ========== QUICK RETAINING ==========
function applyQuickRetaining() {
    const fromVal = parseInt(document.getElementById('retFromPanel').value);
    const toVal = parseInt(document.getElementById('retToPanel').value);
    if (fromVal > toVal) {
        alert('"From" panel must be less than or equal to "To" panel');
        return;
    }
    const from = fromVal - 1;
    const to = toVal - 1;
    const val = parseInt(document.getElementById('retValue').value);
    const run = job.runs[curRun];
    for (let i = Math.max(0, from); i <= Math.min(run.panels.length - 1, to); i++) {
        run.panels[i].retaining = val;
    }
    renderAll();
    autoSave();
}

// ========== PANELS ==========
function updatePanel(i, field, val) {
    const p = job.runs[curRun].panels[i];
    if (field === 'height') p.height = parseInt(val);
    if (field === 'retaining') p.retaining = Math.max(0, Math.min(750, parseInt(val) || 0));
    renderAll(); autoSave();
}

function selectPanel(i) { selPanel = i; renderTable(); renderProfile(); }

function addPanel() {
    const run = job.runs[curRun];
    const last = run.panels[run.panels.length - 1];
    run.panels.push({ height: last?.height || run.defaultHeight, retaining: last?.retaining || 0 });
    run.length = run.panels.length * SUPPLIERS[job.supplier].width;
    renderAll(); autoSave();
}

function removePanel(i) {
    const run = job.runs[curRun];
    if (run.panels.length <= 1) return;
    run.panels.splice(i, 1);
    run.length = run.panels.length * SUPPLIERS[job.supplier].width;
    if (selPanel >= run.panels.length) selPanel = run.panels.length - 1;
    renderAll(); autoSave();
}

// ========== GATES ==========
function addGate() {
    const run = job.runs[curRun];
    job.gates.push({ type: 'pedestrian', width: 900, afterPanel: run.panels.length, runIndex: curRun });
    renderGates(); updateStats(); autoSave();
}

function updateGate(i, field, val) {
    if (field === 'type') job.gates[i].type = val;
    if (field === 'width') {
        const w = parseInt(val);
        if (!Number.isFinite(w) || w < 600 || w > 6000) {
            alert('Gate width must be between 600mm and 6000mm');
            return;
        }
        job.gates[i].width = w;
    }
    if (field === 'afterPanel') job.gates[i].afterPanel = parseInt(val);
    if (field === 'run') job.gates[i].runIndex = parseInt(val);
    renderGates(); updateStats(); autoSave();
}

function removeGate(i) { job.gates.splice(i, 1); renderGates(); updateStats(); autoSave(); }

// ========== CALCULATIONS ==========
function getPlinths(p) { return Math.ceil(p.retaining / 150); }

function getStep(run, i) {
    if (i === 0) return 'level';
    const cur = run.panels[i].retaining;
    const prev = run.panels[i-1].retaining;
    if (cur > prev) return 'down';
    if (cur < prev) return 'up';
    return 'level';
}

function getTotalHeight(p) { return p.height + p.retaining; }

function getPostHeight(p, run, i) {
    const ext = run.extension || 0;
    let maxH = p.height + p.retaining;
    if (i > 0) {
        const prev = run.panels[i - 1];
        maxH = Math.max(maxH, prev.height + prev.retaining);
    }
    if (i < run.panels.length - 1) {
        const next = run.panels[i + 1];
        maxH = Math.max(maxH, next.height + next.retaining);
    }
    const req = maxH + POST_FOOTING_MM + ext;
    const size = POST_SIZES.find(s => s >= req);
    if (!size) {
        console.warn(`Post ${i + 1}: required ${req}mm exceeds max available ${POST_SIZES[POST_SIZES.length - 1]}mm`);
    }
    return size || POST_SIZES[POST_SIZES.length - 1];
}

function needsPatio(p) { return getPlinths(p) >= 3; }
function getPatioForRun(run) { const cnt = run.panels.filter(p => needsPatio(p)).length; return cnt > 0 ? cnt + 1 : 0; }

// ========== SUPPLIER/COLOUR ==========
function onSupplierChange() {
    job.supplier = document.getElementById('supplier').value;
    job.runs.forEach(run => { run.length = run.panels.length * SUPPLIERS[job.supplier].width; });
    renderAll(); autoSave();
}

function onColourChange() { job.colour = document.getElementById('colour').value; renderProfile(); if (threeReady) render3D(); autoSave(); }

// ========== RENDER ==========
function renderAll() { renderTabs(); renderSettings(); renderTable(); renderGates(); updateStats(); renderProfile(); if (threeReady) render3D(); }

function renderTabs() {
    document.getElementById('runTabs').innerHTML = job.runs.map((r, i) => `
        <button class="run-tab ${i === curRun ? 'active' : ''}" onclick="selectRun(${i})">
            ${escapeHtml(r.name)}<span class="num">(${r.panels.length})</span>
        </button>
    `).join('');
}

function renderSettings() {
    const run = job.runs[curRun];
    if (!run) return;
    document.getElementById('runName').value = run.name;
    document.getElementById('defaultHeight').value = run.defaultHeight;
    document.getElementById('extension').value = run.extension;
    const unit = document.getElementById('lengthUnit').value;
    document.getElementById('runLength').value = unit === 'm' ? (run.length/1000).toFixed(2) : run.length;
    // Update quick retaining defaults
    document.getElementById('retToPanel').value = Math.min(3, run.panels.length);
    document.getElementById('retToPanel').max = run.panels.length;
    document.getElementById('retFromPanel').max = run.panels.length;
}

function renderTable() {
    const run = job.runs[curRun];
    if (!run) return;
    let html = '';
    run.panels.forEach((p, i) => {
        const step = getStep(run, i);
        const postH = getPostHeight(p, run, i);
        const patio = needsPatio(p);
        const sel = i === selPanel;
        const plinths = getPlinths(p);
        const total = getTotalHeight(p);
        let blocks = '';
        for (let b = 0; b < 5; b++) blocks += `<div class="ret-block ${b < plinths ? '' : 'empty'}"></div>`;

        html += `<tr class="${sel ? 'selected' : ''}">
            <td><span class="p-num" onclick="selectPanel(${i})">P${i+1}</span></td>
            <td><select onchange="updatePanel(${i},'height',this.value)">
                <option value="1200" ${p.height===1200?'selected':''}>1200</option>
                <option value="1500" ${p.height===1500?'selected':''}>1500</option>
                <option value="1800" ${p.height===1800?'selected':''}>1800</option>
                <option value="2100" ${p.height===2100?'selected':''}>2100</option>
            </select></td>
            <td><select onchange="updatePanel(${i},'retaining',this.value)">
                <option value="0" ${p.retaining===0?'selected':''}>0</option>
                <option value="150" ${p.retaining===150?'selected':''}>150</option>
                <option value="300" ${p.retaining===300?'selected':''}>300</option>
                <option value="450" ${p.retaining===450?'selected':''}>450</option>
                <option value="600" ${p.retaining===600?'selected':''}>600</option>
                <option value="750" ${p.retaining===750?'selected':''}>750</option>
            </select></td>
            <td><div class="ret-visual">${blocks}</div></td>
            <td><span class="step-icon ${step}">${step==='down'?'â†“':step==='up'?'â†‘':'â€”'}</span></td>
            <td><span class="total-ht">${total}</span></td>
            <td><span class="post-ht ${patio?'patio':''}">${postH}</span></td>
            <td><button class="btn-remove" onclick="removePanel(${i})">Ã—</button></td>
        </tr>`;
    });
    html += `<tr class="add-row"><td colspan="8"><button class="btn-add-panel" onclick="addPanel()">+ Add Panel</button></td></tr>`;
    document.getElementById('tableBody').innerHTML = html;
}

function renderGates() {
    const box = document.getElementById('gatesBox');
    if (job.gates.length === 0) {
        box.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:4px 0">No gates added</div>';
        return;
    }
    box.innerHTML = job.gates.map((g, i) => {
        const runOpts = job.runs.map((r, ri) => `<option value="${ri}" ${g.runIndex===ri?'selected':''}>${escapeHtml(r.name)}</option>`).join('');
        const maxP = job.runs[g.runIndex || 0]?.panels.length || 8;
        return `
        <div class="gate-row">
            <select onchange="updateGate(${i},'type',this.value)">
                <option value="pedestrian" ${g.type==='pedestrian'?'selected':''}>Pedestrian</option>
                <option value="single" ${g.type==='single'?'selected':''}>Single Drive</option>
                <option value="double" ${g.type==='double'?'selected':''}>Double Drive</option>
                <option value="sliding" ${g.type==='sliding'?'selected':''}>Sliding</option>
            </select>
            <input type="number" value="${g.width}" onchange="updateGate(${i},'width',this.value)">
            <span>mm</span>
            <span>in</span>
            <select onchange="updateGate(${i},'run',this.value)">${runOpts}</select>
            <span>after P</span>
            <input type="number" value="${g.afterPanel || maxP}" min="1" max="${maxP}" style="width:45px" onchange="updateGate(${i},'afterPanel',this.value)">
            <button class="btn-remove" onclick="removeGate(${i})">Ã—</button>
        </div>`;
    }).join('');
}

function updateStats() {
    const pw = SUPPLIERS[job.supplier].width;
    let panels = 0, plinths = 0, posts = 0;
    job.runs.forEach(run => {
        panels += run.panels.length;
        plinths += run.panels.reduce((s, p) => s + getPlinths(p), 0);
        posts += run.panels.length + 1;
    });
    posts += job.gates.length * 2;
    const metres = (panels * pw) / 1000;
    const pricePerM = parsePricePerM();
    const estimate = metres * pricePerM * (1 + GST_RATE);

    document.getElementById('sMetres').textContent = metres.toFixed(1);
    document.getElementById('sPanels').textContent = panels;
    document.getElementById('sPosts').textContent = posts;
    document.getElementById('sRet').textContent = plinths;
    document.getElementById('sCalc').textContent = `${panels} Ã— ${pw}mm`;
    document.getElementById('sPrice').textContent = '$' + Math.round(estimate).toLocaleString();
}

// ========== CANVAS RESIZE ==========
function setupResize() {
    const box = document.querySelector('.canvas-box');
    if (resizeObserver) resizeObserver.disconnect();
    resizeObserver = new ResizeObserver(entries => {
        for (let e of entries) {
            const { width, height } = e.contentRect;
            if (width > 0 && height > 0) {
                renderProfile();
                if (threeReady) { renderer.setSize(width, height); camera.aspect = width / height; camera.updateProjectionMatrix(); }
            }
        }
    });
    resizeObserver.observe(box);
}

// ========== PROFILE VIEW ==========
function renderProfile() {
    const canvas = document.getElementById('profileCanvas');
    const box = canvas.parentElement;
    const ctx = canvas.getContext('2d');
    const rect = box.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    if (w === 0 || h === 0) return;

    const dpr = window.devicePixelRatio || 1;
    canvas.width = w * dpr; canvas.height = h * dpr;
    canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
    ctx.scale(dpr, dpr);

    const col = COLOURS[job.colour];

    // Sky
    const sky = ctx.createLinearGradient(0, 0, 0, h * 0.6);
    sky.addColorStop(0, '#7dd3fc'); sky.addColorStop(0.6, '#bae6fd'); sky.addColorStop(1, '#e0f2fe');
    ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);

    const groundY = h * 0.55;
    ctx.fillStyle = '#4ade80'; ctx.fillRect(0, groundY, w, 30);

    const soil = ctx.createLinearGradient(0, groundY + 30, 0, h);
    soil.addColorStop(0, '#a3724a'); soil.addColorStop(0.4, '#8b5d3a'); soil.addColorStop(1, '#6b4530');
    ctx.fillStyle = soil; ctx.fillRect(0, groundY + 30, w, h - groundY - 30);

    ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(w, groundY); ctx.stroke();

    const pad = 60, gap = 50;
    let totalP = job.runs.reduce((s, r) => s + r.panels.length, 0);
    if (totalP === 0) return;

    const availW = w - pad * 2 - (job.runs.length - 1) * gap;
    const panelW = Math.min(85, Math.max(35, availW / totalP));

    let maxH = 0;
    job.runs.forEach(run => { run.panels.forEach(p => { const tot = p.height + p.retaining + (run.extension || 0); if (tot > maxH) maxH = tot; }); });

    const hScale = (groundY - pad - 80) / Math.max(maxH, 1800);
    let curX = pad;

    job.runs.forEach((run, ri) => {
        const runW = run.panels.length * panelW;

        ctx.font = 'bold 14px -apple-system, sans-serif'; ctx.fillStyle = '#1e293b'; ctx.textAlign = 'center';
        ctx.fillText(run.name, curX + runW / 2, 26);
        ctx.font = '12px -apple-system, sans-serif'; ctx.fillStyle = '#64748b';
        ctx.fillText(`${run.panels.length} panels Â· ${(run.length / 1000).toFixed(1)}m`, curX + runW / 2, 44);

        run.panels.forEach((p, pi) => {
            const sel = ri === curRun && pi === selPanel;
            const px = curX + pi * panelW;
            const fenceH = p.height * hScale;
            const panelTop = groundY - fenceH;

            const plinths = getPlinths(p);
            const singlePlinthH = 150 * hScale;
            for (let pl = 0; pl < plinths; pl++) {
                const py = groundY + 30 + pl * singlePlinthH;
                const plGrad = ctx.createLinearGradient(px, py, px + panelW, py);
                plGrad.addColorStop(0, '#9ca3af'); plGrad.addColorStop(0.5, '#d1d5db'); plGrad.addColorStop(1, '#9ca3af');
                ctx.fillStyle = plGrad; ctx.fillRect(px + 3, py, panelW - 6, singlePlinthH - 2);
                ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 1; ctx.strokeRect(px + 3, py, panelW - 6, singlePlinthH - 2);
            }

            drawPanel(ctx, px + 3, panelTop, panelW - 6, fenceH, col, sel);

            if (run.extension > 0) {
                const extH = run.extension * hScale;
                ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(px + 3, panelTop - extH, panelW - 6, extH);
                ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1; ctx.strokeRect(px + 3, panelTop - extH, panelW - 6, extH);
            }

            const retH = p.retaining * hScale;
            const postH = fenceH + retH + 25;
            const postGrad = ctx.createLinearGradient(px - 2, 0, px + 6, 0);
            postGrad.addColorStop(0, '#4b5563'); postGrad.addColorStop(0.5, '#6b7280'); postGrad.addColorStop(1, '#4b5563');
            ctx.fillStyle = postGrad; ctx.fillRect(px - 2, groundY - fenceH - 12, 7, postH + 42);

            ctx.fillStyle = '#374151'; ctx.beginPath();
            ctx.moveTo(px - 4, panelTop - 12); ctx.lineTo(px + 1.5, panelTop - 22); ctx.lineTo(px + 7, panelTop - 12); ctx.fill();

            const numX = px + panelW / 2, numY = panelTop + fenceH / 2;
            ctx.fillStyle = 'rgba(0,0,0,0.35)'; ctx.beginPath(); ctx.arc(numX, numY, 13, 0, Math.PI * 2); ctx.fill();
            ctx.font = sel ? 'bold 14px -apple-system' : '13px -apple-system'; ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
            ctx.fillText(pi + 1, numX, numY + 4);

            if (sel) { ctx.strokeStyle = '#059669'; ctx.lineWidth = 3; ctx.strokeRect(px + 1, panelTop - 2, panelW - 2, fenceH + 4); }
        });

        const last = run.panels[run.panels.length - 1];
        const lastX = curX + run.panels.length * panelW;
        const lastFH = last.height * hScale;
        const lastRH = last.retaining * hScale;
        const finalPostH = lastFH + lastRH + 25;

        const pGrad = ctx.createLinearGradient(lastX - 5, 0, lastX + 3, 0);
        pGrad.addColorStop(0, '#4b5563'); pGrad.addColorStop(0.5, '#6b7280'); pGrad.addColorStop(1, '#4b5563');
        ctx.fillStyle = pGrad; ctx.fillRect(lastX - 5, groundY - lastFH - 12, 7, finalPostH + 42);

        ctx.fillStyle = '#374151'; ctx.beginPath();
        ctx.moveTo(lastX - 7, groundY - lastFH - 12); ctx.lineTo(lastX - 1.5, groundY - lastFH - 22); ctx.lineTo(lastX + 4, groundY - lastFH - 12); ctx.fill();

        curX += runW + gap;
    });
}

function drawPanel(ctx, x, y, w, h, col, sel) {
    const rgb = hexToRgb(col);
    const ribs = Math.max(4, Math.floor(w / 9));
    const ribW = w / ribs;

    for (let i = 0; i < ribs; i++) {
        const rx = x + i * ribW;
        const raised = i % 2 === 0;
        const shade = raised ? 1.0 : 0.8;
        ctx.fillStyle = `rgb(${Math.round(rgb.r*shade)},${Math.round(rgb.g*shade)},${Math.round(rgb.b*shade)})`;
        ctx.fillRect(rx, y, ribW - 0.5, h);
        if (raised && ribW > 5) { ctx.fillStyle = 'rgba(255,255,255,0.18)'; ctx.fillRect(rx + 1, y, 2, h); }
    }

    ctx.fillStyle = '#52525b'; ctx.fillRect(x - 1, y - 4, w + 2, 5);
    ctx.fillStyle = '#71717a'; ctx.fillRect(x - 1, y - 4, w + 2, 2);

    ctx.strokeStyle = sel ? '#059669' : '#374151';
    ctx.lineWidth = sel ? 3 : 1;
    ctx.strokeRect(x, y, w, h);
}

function hexToRgb(hex) {
    const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return r ? { r: parseInt(r[1],16), g: parseInt(r[2],16), b: parseInt(r[3],16) } : { r:128, g:128, b:128 };
}

// ========== 3D VIEW ==========
function init3D() {
    if (threeReady) return;
    const box = document.getElementById('threeBox');
    const rect = box.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) { setTimeout(init3D, 100); return; }

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    camera = new THREE.PerspectiveCamera(40, rect.width / rect.height, 0.1, 100);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(rect.width, rect.height);
    renderer.shadowMap.enabled = true;
    box.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(5, 10, 7); sun.castShadow = true; scene.add(sun);

    const groundGeo = new THREE.PlaneGeometry(15, 15);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x7cb342, roughness: 0.9 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);

    setupControls();
    threeReady = true;
    render3D();
    animate3D();
}

let camTarget = new THREE.Vector3(0, 0.3, 0);
let isDragging = false, prevMX = 0, prevMY = 0;

function setupControls() {
    const el = renderer.domElement;
    el.addEventListener('mousedown', e => { isDragging = true; prevMX = e.clientX; prevMY = e.clientY; });
    window.addEventListener('mouseup', () => isDragging = false);
    el.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const dx = e.clientX - prevMX, dy = e.clientY - prevMY;
        const sph = new THREE.Spherical();
        sph.setFromVector3(camera.position.clone().sub(camTarget));
        sph.theta -= dx * 0.01; sph.phi -= dy * 0.01;
        sph.phi = Math.max(0.1, Math.min(Math.PI/2 - 0.1, sph.phi));
        camera.position.setFromSpherical(sph).add(camTarget);
        camera.lookAt(camTarget);
        prevMX = e.clientX; prevMY = e.clientY;
    });
    el.addEventListener('wheel', e => {
        e.preventDefault();
        const f = e.deltaY > 0 ? 1.1 : 0.9;
        const dir = camera.position.clone().sub(camTarget).multiplyScalar(f);
        if (dir.length() > 0.8 && dir.length() < 15) camera.position.copy(camTarget).add(dir);
    }, { passive: false });
}

function animate3D() { requestAnimationFrame(animate3D); if (renderer) renderer.render(scene, camera); }

function render3D() {
    if (!scene) return;

    const rem = [];
    scene.traverse(o => { if (o.userData.fence) rem.push(o); });
    const disposedMats = new Set();
    rem.forEach(o => {
        if (o.geometry) o.geometry.dispose();
        if (o.material && !disposedMats.has(o.material)) { o.material.dispose(); disposedMats.add(o.material); }
        scene.remove(o);
    });

    const col = new THREE.Color(COLOURS[job.colour]);
    const pwM = SUPPLIERS[job.supplier].width / 1000;
    const sc = SCALE_3D;

    let offX = 0, totalW = 0, maxH = 0;
    job.runs.forEach(run => { totalW += run.panels.length * pwM * sc; run.panels.forEach(p => { const h = (p.height / 1000) * sc; if (h > maxH) maxH = h; }); });
    totalW += (job.runs.length - 1) * 0.12;

    job.runs.forEach(run => {
        run.panels.forEach((p, pi) => {
            const fH = (p.height / 1000) * sc;
            const pW = pwM * sc;
            const retH = (p.retaining / 1000) * sc;

            const grp = new THREE.Group();
            const ribs = 12;
            const ribW = pW / ribs;
            for (let r = 0; r < ribs; r++) {
                const geo = new THREE.BoxGeometry(ribW * 0.9, fH, 0.014);
                const shade = r % 2 === 0 ? 1 : 0.75;
                const mat = new THREE.MeshStandardMaterial({ color: col.clone().multiplyScalar(shade), metalness: 0.4, roughness: 0.6 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(ribW * (r + 0.5) - pW / 2, 0, r % 2 === 0 ? 0.007 : -0.007);
                mesh.castShadow = true;
                grp.add(mesh);
            }
            grp.position.set(offX + pW / 2, fH / 2, 0);
            grp.userData.fence = true;
            scene.add(grp);

            const plinths = getPlinths(p);
            const singleH = 0.15 * sc;
            for (let pl = 0; pl < plinths; pl++) {
                const geo = new THREE.BoxGeometry(pW * 0.95, singleH * 0.9, 0.028);
                const mat = new THREE.MeshStandardMaterial({ color: 0x9ca3af, roughness: 0.9 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(offX + pW / 2, -singleH * (pl + 0.5), 0);
                mesh.userData.fence = true;
                scene.add(mesh);
            }

            const postH = fH + retH + 0.1;
            const postGeo = new THREE.BoxGeometry(0.045, postH, 0.045);
            const postMat = new THREE.MeshStandardMaterial({ color: 0x52525b, metalness: 0.5 });
            const post = new THREE.Mesh(postGeo, postMat);
            post.position.set(offX, postH / 2 - retH, 0);
            post.castShadow = true; post.userData.fence = true;
            scene.add(post);

            const capGeo = new THREE.ConeGeometry(0.035, 0.055, 4);
            const cap = new THREE.Mesh(capGeo, new THREE.MeshStandardMaterial({ color: 0x374151 }));
            cap.position.set(offX, fH + 0.11, 0);
            cap.rotation.y = Math.PI / 4;
            cap.userData.fence = true;
            scene.add(cap);

            offX += pW;
        });

        const last = run.panels[run.panels.length - 1];
        const lastFH = (last.height / 1000) * sc;
        const lastRH = (last.retaining / 1000) * sc;
        const finalPostH = lastFH + lastRH + 0.1;

        const postGeo = new THREE.BoxGeometry(0.045, finalPostH, 0.045);
        const postMat = new THREE.MeshStandardMaterial({ color: 0x52525b, metalness: 0.5 });
        const post = new THREE.Mesh(postGeo, postMat);
        post.position.set(offX, finalPostH / 2 - lastRH, 0);
        post.castShadow = true; post.userData.fence = true;
        scene.add(post);

        const capGeo = new THREE.ConeGeometry(0.035, 0.055, 4);
        const cap = new THREE.Mesh(capGeo, new THREE.MeshStandardMaterial({ color: 0x374151 }));
        cap.position.set(offX, lastFH + 0.11, 0);
        cap.rotation.y = Math.PI / 4;
        cap.userData.fence = true;
        scene.add(cap);

        offX += 0.12;
    });

    const centerX = (offX - 0.12) / 2;
    camTarget.set(centerX, maxH * 0.5, 0);
    const dist = Math.max(1.2, totalW * 0.6);
    camera.position.set(centerX + dist * 0.4, maxH * 0.7 + 0.4, dist * 0.85);
    camera.lookAt(camTarget);
}

function showView(v) {
    const area = document.getElementById('vizArea');
    document.getElementById('tabProfile').classList.toggle('active', v === 'profile');
    document.getElementById('tab3d').classList.toggle('active', v === '3d');
    if (v === '3d') { area.classList.add('mode-3d'); if (!threeReady) setTimeout(init3D, 50); else render3D(); }
    else { area.classList.remove('mode-3d'); renderProfile(); }
}

// ========== OUTPUTS ==========
function showOutputs() { document.getElementById('modalBg').classList.add('open'); renderOutput(); }
function closeModal() { document.getElementById('modalBg').classList.remove('open'); }

function switchTab(btn, tab) {
    curTab = tab;
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderOutput();
}

function renderOutput() {
    const spec = SUPPLIERS[job.supplier];
    const pricePerM = parsePricePerM();
    let totalPanels = 0, totalPlinths = 0, totalPosts = 0, totalPatio = 0;
    let groups = {};

    job.runs.forEach(run => {
        totalPatio += getPatioForRun(run);
        run.panels.forEach((p, i) => {
            totalPanels++;
            totalPlinths += getPlinths(p);
            const postH = getPostHeight(p, run, i);
            const key = `${p.height}-${postH}`;
            if (!groups[key]) groups[key] = { sheetH: p.height, postH, count: 0 };
            groups[key].count++;
        });
        totalPosts += run.panels.length + 1;
    });
    totalPosts += job.gates.length * 2;
    const concrete = Math.ceil(totalPosts * 2);
    const totalM = (totalPanels * spec.width) / 1000;

    let out = '';

    if (curTab === 'material') {
        const deliveryDate = new Date(job.date || new Date());
        deliveryDate.setDate(deliveryDate.getDate() - 1);
        // Skip weekends: if Saturday go to Friday, if Sunday go to Friday
        if (deliveryDate.getDay() === 0) deliveryDate.setDate(deliveryDate.getDate() - 2);
        if (deliveryDate.getDay() === 6) deliveryDate.setDate(deliveryDate.getDate() - 1);
        const deliveryStr = deliveryDate.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' });
        let items = [], n = 1;
        Object.values(groups).forEach(g => {
            items.push(`${n}) ${g.count} x ${g.sheetH}mm panels with ${g.postH}mm posts\n   Profile: ${spec.profile}\n   Colour: ${job.colour}`);
            n++;
        });
        if (totalPlinths > 0) { items.push(`${n}) ${totalPlinths} x 150mm Plinths - ${job.colour}`); n++; }
        if (totalPatio > 0) { items.push(`${n}) ${totalPatio} x 76x38 RHS Patio Tube @ 3000mm`); n++; }
        job.gates.forEach(g => {
            const desc = g.type === 'pedestrian' ? 'Pedestrian' : g.type === 'single' ? 'Single Drive' : g.type === 'double' ? 'Double Drive' : 'Sliding';
            const runName = job.runs[g.runIndex || 0]?.name || 'Run';
            items.push(`${n}) 2 x 50x50 SHS gate posts @ 2100mm (${g.width}mm ${desc} in ${runName} after P${g.afterPanel})`);
            n++;
        });
        items.push(`${n}) ${concrete} x Bags Quickset Concrete`);
        items.push(`${n+1}) Fixings, Post Caps, Screws as required`);

        out = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          MATERIAL ORDER - ${job.ref}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

To: ${spec.name} Sales

Hi Team,

Please order the following for delivery:

Delivery: ${deliveryStr}
Address:  ${job.address || '[Address]'}
Contact:  ${job.client || '[Client]'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MATERIALS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${items.join('\n\n')}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Please confirm. Thanks!

SecureWorks WA`;
    } else if (curTab === 'work') {
        const runsT = job.runs.map(run => {
            const det = run.panels.map((p, i) => {
                const patio = needsPatio(p) ? ' â€ ' : '';
                const total = getTotalHeight(p);
                return `  P${i+1}: ${p.height}mm fence + ${p.retaining}mm ret = ${total}mm total${patio}`;
            }).join('\n');
            const runPatio = getPatioForRun(run);
            const note = runPatio > 0 ? ` [${runPatio} patio tubes]` : '';
            return `${run.name} (${run.panels.length} panels, ${(run.length/1000).toFixed(1)}m)${note}\n${det}`;
        }).join('\n\n');

        const gatesT = job.gates.length > 0 ? job.gates.map(g => {
            const runName = job.runs[g.runIndex || 0]?.name || 'Run';
            return `  ${g.type}: ${g.width}mm in ${runName} after P${g.afterPanel}`;
        }).join('\n') : '  None';

        out = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            WORK ORDER - ${job.ref}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Client:   ${job.client || '[Client]'}
Address:  ${job.address || '[Address]'}
Date:     ${job.date || 'TBD'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FENCE RUNS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${runsT}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GATES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${gatesT}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SUMMARY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Total Length:  ${totalM.toFixed(1)}m
  Panels:        ${totalPanels}
  Posts:         ${totalPosts}
  Plinths:       ${totalPlinths}
  Patio Tubes:   ${totalPatio}
  Concrete:      ${concrete} bags

â€  = Patio tube required (3+ plinths / 450mm+ retaining)`;
    } else {
        const sub = totalM * pricePerM;
        const gst = sub * GST_RATE;
        const total = sub + gst;

        out = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               QUOTE - ${job.ref}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Client: ${job.client || '[Client]'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SCOPE OF WORKS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${totalM.toFixed(1)}m Colorbond Fencing
Colour: ${job.colour}

Includes:
â€¢ Supply of all materials
â€¢ Professional installation
â€¢ Posts set in concrete
â€¢ Site clean up

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PRICING (@ $${pricePerM}/m)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Subtotal:     $${sub.toFixed(2).padStart(10)}
GST (10%):    $${gst.toFixed(2).padStart(10)}
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL:        $${total.toFixed(2).padStart(10)}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Quote valid for 30 days.

SecureWorks WA
ABN: XX XXX XXX XXX`;
    }

    document.getElementById('outputPre').textContent = out;
}

function copyOutput(e) {
    const txt = document.getElementById('outputPre').textContent;
    const btn = e.target.closest('.m-btn-pri');
    navigator.clipboard.writeText(txt).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ“ Copied!';
        setTimeout(() => btn.innerHTML = orig, 1500);
    });
}

// ========== START ==========
window.addEventListener('load', init);
</script>
</body>
</html>
